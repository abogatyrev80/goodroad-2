<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Good Road - –ü–∞–Ω–µ–ª—å –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #0f172a;
            color: #e2e8f0;
            line-height: 1.6;
        }
        
        /* Header */
        .header {
            background: linear-gradient(135deg, #1e40af 0%, #7c3aed 100%);
            padding: 1.5rem 2rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header-content {
            max-width: 1600px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            font-size: 1.75rem;
            font-weight: 700;
            color: white;
        }
        
        .header-actions {
            display: flex;
            gap: 1rem;
        }
        
        .btn {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            border: none;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn-primary {
            background: #10b981;
            color: white;
        }
        
        .btn-primary:hover {
            background: #059669;
        }
        
        .btn-secondary {
            background: #3b82f6;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #2563eb;
        }
        
        .btn-danger {
            background: #ef4444;
            color: white;
        }
        
        .btn-danger:hover {
            background: #dc2626;
        }
        
        .btn-outline {
            background: transparent;
            border: 1px solid #475569;
            color: #e2e8f0;
        }
        
        .btn-outline:hover {
            background: #1e293b;
        }
        
        /* Main Container */
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: #1e293b;
            padding: 1.5rem;
            border-radius: 0.75rem;
            border: 1px solid #334155;
        }
        
        .stat-card h3 {
            font-size: 0.875rem;
            color: #94a3b8;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .stat-card .value {
            font-size: 2rem;
            font-weight: 700;
            color: #10b981;
        }
        
        /* Map Container */
        .map-container {
            background: #1e293b;
            border-radius: 0.75rem;
            overflow: hidden;
            margin-bottom: 2rem;
            border: 1px solid #334155;
        }
        
        .map-header {
            padding: 1rem 1.5rem;
            background: #0f172a;
            border-bottom: 1px solid #334155;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .map-header h2 {
            font-size: 1.25rem;
            font-weight: 600;
            color: #e2e8f0;
        }
        
        #map {
            height: 500px;
            width: 100%;
        }
        
        /* Toolbar */
        .toolbar {
            background: #1e293b;
            padding: 1.5rem;
            border-radius: 0.75rem;
            margin-bottom: 1.5rem;
            border: 1px solid #334155;
        }
        
        .toolbar-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .toolbar-left, .toolbar-right {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        
        .search-box {
            position: relative;
        }
        
        .search-box input {
            padding: 0.5rem 1rem 0.5rem 2.5rem;
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 0.5rem;
            color: #e2e8f0;
            font-size: 0.875rem;
            width: 300px;
        }
        
        .search-box input:focus {
            outline: none;
            border-color: #3b82f6;
        }
        
        .search-icon {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: #64748b;
        }
        
        select {
            padding: 0.5rem 1rem;
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 0.5rem;
            color: #e2e8f0;
            font-size: 0.875rem;
            cursor: pointer;
        }
        
        select:focus {
            outline: none;
            border-color: #3b82f6;
        }
        
        /* Table Container */
        .table-container {
            background: #1e293b;
            border-radius: 0.75rem;
            overflow: hidden;
            border: 1px solid #334155;
        }
        
        .table-wrapper {
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        thead {
            background: #0f172a;
        }
        
        th {
            padding: 1rem;
            text-align: left;
            font-size: 0.875rem;
            font-weight: 600;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-bottom: 2px solid #334155;
            cursor: pointer;
            user-select: none;
            position: relative;
        }
        
        th:hover {
            background: #1e293b;
        }
        
        th.sortable::after {
            content: '‚áÖ';
            position: absolute;
            right: 0.5rem;
            opacity: 0.3;
        }
        
        th.sort-asc::after {
            content: '‚Üë';
            opacity: 1;
            color: #3b82f6;
        }
        
        th.sort-desc::after {
            content: '‚Üì';
            opacity: 1;
            color: #3b82f6;
        }
        
        tbody tr {
            border-bottom: 1px solid #334155;
            transition: background 0.2s;
        }
        
        tbody tr:hover {
            background: #0f172a;
        }
        
        td {
            padding: 1rem;
            font-size: 0.875rem;
        }
        
        td.nowrap {
            white-space: nowrap;
        }
        
        /* Checkbox */
        .checkbox {
            width: 1.25rem;
            height: 1.25rem;
            cursor: pointer;
        }
        
        /* Badges */
        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .badge-success {
            background: #065f46;
            color: #10b981;
        }
        
        .badge-warning {
            background: #78350f;
            color: #fbbf24;
        }
        
        .badge-danger {
            background: #7f1d1d;
            color: #ef4444;
        }
        
        .badge-info {
            background: #1e3a8a;
            color: #60a5fa;
        }
        
        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 0.5rem;
        }
        
        .btn-icon {
            width: 2rem;
            height: 2rem;
            padding: 0;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.375rem;
            border: 1px solid #334155;
            background: transparent;
            color: #94a3b8;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-icon:hover {
            background: #0f172a;
            color: #e2e8f0;
        }
        
        .btn-icon.edit:hover {
            color: #3b82f6;
            border-color: #3b82f6;
        }
        
        .btn-icon.delete:hover {
            color: #ef4444;
            border-color: #ef4444;
        }
        
        /* Pagination */
        .pagination {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            background: #0f172a;
            border-top: 1px solid #334155;
        }
        
        .pagination-info {
            color: #94a3b8;
            font-size: 0.875rem;
        }
        
        .pagination-controls {
            display: flex;
            gap: 0.5rem;
        }
        
        .pagination-btn {
            padding: 0.5rem 1rem;
            background: transparent;
            border: 1px solid #334155;
            border-radius: 0.375rem;
            color: #e2e8f0;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .pagination-btn:hover:not(:disabled) {
            background: #1e293b;
            border-color: #3b82f6;
        }
        
        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .pagination-btn.active {
            background: #3b82f6;
            border-color: #3b82f6;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.75);
            animation: fadeIn 0.2s;
        }
        
        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .modal-content {
            background: #1e293b;
            border-radius: 0.75rem;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid #334155;
            animation: slideUp 0.3s;
        }
        
        @keyframes slideUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid #334155;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h2 {
            font-size: 1.25rem;
            font-weight: 600;
        }
        
        .modal-close {
            background: none;
            border: none;
            color: #94a3b8;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: 2rem;
            height: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.375rem;
        }
        
        .modal-close:hover {
            background: #0f172a;
            color: #e2e8f0;
        }
        
        .modal-body {
            padding: 1.5rem;
        }
        
        .modal-footer {
            padding: 1.5rem;
            border-top: 1px solid #334155;
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }
        
        /* Form */
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
            font-weight: 600;
            color: #94a3b8;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 0.5rem;
            color: #e2e8f0;
            font-size: 0.875rem;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3b82f6;
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }
        
        /* Loading */
        .loading {
            display: none;
            text-align: center;
            padding: 2rem;
        }
        
        .loading.active {
            display: block;
        }
        
        .spinner {
            border: 3px solid #334155;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Filters Panel */
        .filters-panel {
            background: #1e293b;
            padding: 1.5rem;
            border-radius: 0.75rem;
            margin-bottom: 1.5rem;
            border: 1px solid #334155;
            display: none;
        }
        
        .filters-panel.active {
            display: block;
        }
        
        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .filter-group label {
            font-size: 0.875rem;
            color: #94a3b8;
            font-weight: 600;
        }
        
        .filter-actions {
            margin-top: 1rem;
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }
        
        /* Notification */
        .notification {
            position: fixed;
            top: 1rem;
            right: 1rem;
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 0.75rem;
            padding: 1rem 1.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
            z-index: 2000;
            min-width: 300px;
            animation: slideIn 0.3s;
            display: none;
        }
        
        .notification.active {
            display: block;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .notification.success {
            border-left: 4px solid #10b981;
        }
        
        .notification.error {
            border-left: 4px solid #ef4444;
        }
        
        .notification.info {
            border-left: 4px solid #3b82f6;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .toolbar-row {
                flex-direction: column;
                align-items: stretch;
            }
            
            .search-box input {
                width: 100%;
            }
            
            .table-wrapper {
                overflow-x: scroll;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div>
                <h1>üöó Good Road - –ü–∞–Ω–µ–ª—å –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h1>
            </div>
            <div class="header-actions">
                <button class="btn btn-secondary" onclick="exportCSV()">
                    üìä –≠–∫—Å–ø–æ—Ä—Ç CSV
                </button>
                <button class="btn btn-secondary" onclick="openImportModal()">
                    üì• –ò–º–ø–æ—Ä—Ç CSV
                </button>
                <button class="btn btn-primary" onclick="loadData()">
                    üîÑ –û–±–Ω–æ–≤–∏—Ç—å
                </button>
            </div>
        </div>
    </header>

    <!-- Main Container -->
    <div class="container">
        <!-- Statistics -->
        <div class="stats-grid">
            <div class="stat-card">
                <h3>–í—Å–µ–≥–æ —Ç–æ—á–µ–∫</h3>
                <div class="value" id="stat-total">0</div>
            </div>
            <div class="stat-card">
                <h3>–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ</h3>
                <div class="value" id="stat-verified">0</div>
            </div>
            <div class="stat-card">
                <h3>–ü—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–π</h3>
                <div class="value" id="stat-hazards">0</div>
            </div>
            <div class="stat-card">
                <h3>–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª</h3>
                <div class="value" id="stat-avg">0</div>
            </div>
        </div>

        <!-- Map -->
        <div class="map-container">
            <div class="map-header">
                <h2>üó∫Ô∏è –ö–∞—Ä—Ç–∞ —Ç–æ—á–µ–∫ –¥–∞–Ω–Ω—ã—Ö</h2>
                <button class="btn btn-outline" onclick="toggleMapSize()">
                    üìê –ò–∑–º–µ–Ω–∏—Ç—å —Ä–∞–∑–º–µ—Ä
                </button>
            </div>
            <div id="map"></div>
        </div>

        <!-- Toolbar -->
        <div class="toolbar">
            <div class="toolbar-row">
                <div class="toolbar-left">
                    <div class="search-box">
                        <span class="search-icon">üîç</span>
                        <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫ –ø–æ —Ç–∞–±–ª–∏—Ü–µ..." onkeyup="searchTable()">
                    </div>
                    <button class="btn btn-outline" onclick="toggleFilters()">
                        üîß –§–∏–ª—å—Ç—Ä—ã
                    </button>
                </div>
                <div class="toolbar-right">
                    <select id="rowsPerPage" onchange="changeRowsPerPage()">
                        <option value="10">10 —Å—Ç—Ä–æ–∫</option>
                        <option value="25" selected>25 —Å—Ç—Ä–æ–∫</option>
                        <option value="50">50 —Å—Ç—Ä–æ–∫</option>
                        <option value="100">100 —Å—Ç—Ä–æ–∫</option>
                    </select>
                    <button class="btn btn-danger" onclick="openBulkDeleteModal()" id="bulkDeleteBtn" disabled>
                        üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ
                    </button>
                </div>
            </div>
        </div>

        <!-- Filters Panel -->
        <div class="filters-panel" id="filtersPanel">
            <h3 style="margin-bottom: 1rem;">–§–∏–ª—å—Ç—Ä—ã –¥–ª—è –º–∞—Å—Å–æ–≤–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è</h3>
            <div class="filters-grid">
                <div class="filter-group">
                    <label>–î–∞—Ç–∞ –æ—Ç</label>
                    <input type="date" id="filter-date-from">
                </div>
                <div class="filter-group">
                    <label>–î–∞—Ç–∞ –¥–æ</label>
                    <input type="date" id="filter-date-to">
                </div>
                <div class="filter-group">
                    <label>–¢–∏–ø –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è</label>
                    <select id="filter-hazard-type">
                        <option value="">–í—Å–µ</option>
                        <option value="pothole">–Ø–º–∞</option>
                        <option value="speed_bump">–õ–µ–∂–∞—á–∏–π –ø–æ–ª–∏—Ü–µ–π—Å–∫–∏–π</option>
                        <option value="road_defect">–î–µ—Ñ–µ–∫—Ç –ø–æ–∫—Ä—ã—Ç–∏—è</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>–°—Ç–∞—Ç—É—Å –ø—Ä–æ–≤–µ—Ä–∫–∏</label>
                    <select id="filter-verified">
                        <option value="">–í—Å–µ</option>
                        <option value="true">–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ</option>
                        <option value="false">–ù–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ</option>
                    </select>
                </div>
            </div>
            <div class="filter-actions">
                <button class="btn btn-outline" onclick="clearFilters()">–û—á–∏—Å—Ç–∏—Ç—å</button>
                <button class="btn btn-primary" onclick="previewBulkDelete()">–ü—Ä–µ–≤—å—é —É–¥–∞–ª–µ–Ω–∏—è</button>
            </div>
        </div>

        <!-- Table -->
        <div class="table-container">
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th><input type="checkbox" class="checkbox" id="selectAll" onchange="toggleSelectAll()"></th>
                            <th class="sortable" onclick="sortTable('timestamp')">–î–∞—Ç–∞/–í—Ä–µ–º—è</th>
                            <th class="sortable" onclick="sortTable('deviceId')">–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ</th>
                            <th class="sortable" onclick="sortTable('latitude')">–®–∏—Ä–æ—Ç–∞</th>
                            <th class="sortable" onclick="sortTable('longitude')">–î–æ–ª–≥–æ—Ç–∞</th>
                            <th class="sortable" onclick="sortTable('speed')">–°–∫–æ—Ä–æ—Å—Ç—å</th>
                            <th class="sortable" onclick="sortTable('road_quality_score')">–ö–∞—á–µ—Å—Ç–≤–æ</th>
                            <th class="sortable" onclick="sortTable('hazard_type')">–ü—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–µ</th>
                            <th class="sortable" onclick="sortTable('severity')">–£—Ä–æ–≤–µ–Ω—å</th>
                            <th>–°—Ç–∞—Ç—É—Å</th>
                            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody id="dataTable">
                        <tr>
                            <td colspan="11" style="text-align: center; padding: 3rem;">
                                <div class="loading active">
                                    <div class="spinner"></div>
                                    <p style="margin-top: 1rem; color: #94a3b8;">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="pagination">
                <div class="pagination-info" id="paginationInfo">
                    –ü–æ–∫–∞–∑–∞–Ω–æ 0 –∏–∑ 0
                </div>
                <div class="pagination-controls">
                    <button class="pagination-btn" onclick="changePage(-1)" id="prevBtn" disabled>–ù–∞–∑–∞–¥</button>
                    <span id="pageNumbers"></span>
                    <button class="pagination-btn" onclick="changePage(1)" id="nextBtn" disabled>–í–ø–µ—Ä—ë–¥</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div class="modal" id="editModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø–∏—Å—å</h2>
                <button class="modal-close" onclick="closeEditModal()">√ó</button>
            </div>
            <div class="modal-body">
                <form id="editForm">
                    <input type="hidden" id="edit-id">
                    <div class="form-group">
                        <label>–¢–∏–ø –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è</label>
                        <select id="edit-hazard-type">
                            <option value="">–ù–µ—Ç</option>
                            <option value="pothole">–Ø–º–∞</option>
                            <option value="speed_bump">–õ–µ–∂–∞—á–∏–π –ø–æ–ª–∏—Ü–µ–π—Å–∫–∏–π</option>
                            <option value="road_defect">–î–µ—Ñ–µ–∫—Ç –ø–æ–∫—Ä—ã—Ç–∏—è</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>–£—Ä–æ–≤–µ–Ω—å –æ–ø–∞—Å–Ω–æ—Å—Ç–∏</label>
                        <select id="edit-severity">
                            <option value="low">–ù–∏–∑–∫–∏–π</option>
                            <option value="medium">–°—Ä–µ–¥–Ω–∏–π</option>
                            <option value="high">–í—ã—Å–æ–∫–∏–π</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ</label>
                        <select id="edit-verified">
                            <option value="false">–ù–µ—Ç</option>
                            <option value="true">–î–∞</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>–ó–∞–º–µ—Ç–∫–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</label>
                        <textarea id="edit-notes"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeEditModal()">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn btn-primary" onclick="saveEdit()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- Import Modal -->
    <div class="modal" id="importModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>–ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö –∏–∑ CSV</h2>
                <button class="modal-close" onclick="closeImportModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>–í—ã–±–µ—Ä–∏—Ç–µ CSV —Ñ–∞–π–ª</label>
                    <input type="file" id="csvFile" accept=".csv">
                </div>
                <div style="margin-top: 1rem; padding: 1rem; background: #0f172a; border-radius: 0.5rem; font-size: 0.875rem;">
                    <p style="color: #94a3b8; margin-bottom: 0.5rem;"><strong>–§–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞:</strong></p>
                    <p style="color: #64748b;">CSV —Ñ–∞–π–ª –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –∑–∞–≥–æ–ª–æ–≤–∫–∏ –∫–æ–ª–æ–Ω–æ–∫ –∫–∞–∫ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeImportModal()">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn btn-primary" onclick="importCSV()">–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification">
        <div id="notificationMessage"></div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        // Global state
        let allData = [];
        let filteredData = [];
        let currentPage = 1;
        let rowsPerPage = 25;
        let sortColumn = 'timestamp';
        let sortDirection = 'desc';
        let selectedRows = new Set();
        let map = null;
        let markers = [];
        let mapExpanded = false;

        // Load data on page load
        window.addEventListener('load', () => {
            initMap();
            loadData();
        });

        // Initialize map
        function initMap() {
            map = L.map('map').setView([55.7558, 37.6173], 10); // Moscow center
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);
        }

        // Update map with data points
        function updateMap() {
            // Clear existing markers
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];
            
            if (filteredData.length === 0) return;
            
            // Add markers for each point
            filteredData.forEach(point => {
                if (!point.latitude || !point.longitude) return;
                
                const lat = point.latitude;
                const lng = point.longitude;
                
                // Determine marker color based on hazard type
                let color = '#10b981'; // green for good
                if (point.hazard_type) {
                    color = '#ef4444'; // red for hazard
                }
                
                const marker = L.circleMarker([lat, lng], {
                    radius: 6,
                    fillColor: color,
                    color: '#fff',
                    weight: 1,
                    opacity: 1,
                    fillOpacity: 0.8
                });
                
                // Add popup with details
                const popupContent = `
                    <div style="color: #1e293b;">
                        <strong>${formatDate(point.timestamp)}</strong><br>
                        <strong>–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ:</strong> ${point.deviceId || 'N/A'}<br>
                        <strong>–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã:</strong> ${lat.toFixed(5)}, ${lng.toFixed(5)}<br>
                        <strong>–°–∫–æ—Ä–æ—Å—Ç—å:</strong> ${point.speed?.toFixed(1) || '0.0'} –∫–º/—á<br>
                        <strong>–ö–∞—á–µ—Å—Ç–≤–æ –¥–æ—Ä–æ–≥–∏:</strong> ${point.road_quality_score || 0}<br>
                        ${point.hazard_type ? `<strong>–ü—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–µ:</strong> ${hazardTypeLabel(point.hazard_type)}<br>` : ''}
                        <strong>–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ:</strong> ${point.is_verified ? '–î–∞' : '–ù–µ—Ç'}
                    </div>
                `;
                
                marker.bindPopup(popupContent);
                marker.addTo(map);
                markers.push(marker);
            });
            
            // Fit map to markers bounds if we have data
            if (markers.length > 0) {
                const group = L.featureGroup(markers);
                map.fitBounds(group.getBounds().pad(0.1));
            }
        }

        // Toggle map size
        function toggleMapSize() {
            const mapElement = document.getElementById('map');
            if (mapExpanded) {
                mapElement.style.height = '500px';
                mapExpanded = false;
            } else {
                mapElement.style.height = '800px';
                mapExpanded = true;
            }
            setTimeout(() => map.invalidateSize(), 100);
        }

        // Load data from API
        async function loadData() {
            try {
                showNotification('–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...', 'info');
                
                // Load analytics
                const analyticsRes = await fetch('/api/admin/analytics');
                const analytics = await analyticsRes.json();
                
                // Update stats
                document.getElementById('stat-total').textContent = analytics.total_points || 0;
                document.getElementById('stat-verified').textContent = analytics.verified_points || 0;
                document.getElementById('stat-hazards').textContent = analytics.hazard_points || 0;
                document.getElementById('stat-avg').textContent = analytics.avg_road_quality?.toFixed(1) || '0.0';
                
                // Load sensor data
                const dataRes = await fetch('/api/admin/sensor-data?limit=10000');
                const dataJson = await dataRes.json();
                
                allData = dataJson.data || [];
                filteredData = [...allData];
                
                renderTable();
                showNotification('–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!', 'success');
            } catch (error) {
                console.error('Error loading data:', error);
                showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ' + error.message, 'error');
            }
        }

        // Render table
        function renderTable() {
            const tbody = document.getElementById('dataTable');
            const start = (currentPage - 1) * rowsPerPage;
            const end = start + rowsPerPage;
            const pageData = filteredData.slice(start, end);
            
            if (pageData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="11" style="text-align: center; padding: 3rem; color: #64748b;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</td></tr>';
                updatePagination();
                return;
            }
            
            tbody.innerHTML = pageData.map(row => `
                <tr>
                    <td><input type="checkbox" class="checkbox row-checkbox" data-id="${row._id}" onchange="updateSelectAll()"></td>
                    <td class="nowrap">${formatDate(row.timestamp)}</td>
                    <td>${row.deviceId || 'N/A'}</td>
                    <td>${row.latitude?.toFixed(5) || '0.00000'}</td>
                    <td>${row.longitude?.toFixed(5) || '0.00000'}</td>
                    <td>${row.speed?.toFixed(1) || '0.0'} –∫–º/—á</td>
                    <td>${row.road_quality_score || 0}</td>
                    <td>${row.hazard_type ? hazardTypeLabel(row.hazard_type) : '-'}</td>
                    <td>${severityBadge(row.severity)}</td>
                    <td>${verifiedBadge(row.is_verified)}</td>
                    <td class="nowrap">
                        <div class="action-buttons">
                            <button class="btn-icon edit" onclick="openEditModal('${row._id}')" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
                                ‚úèÔ∏è
                            </button>
                            <button class="btn-icon delete" onclick="deleteRow('${row._id}')" title="–£–¥–∞–ª–∏—Ç—å">
                                üóëÔ∏è
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
            
            updatePagination();
        }

        // Format date
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString('ru-RU', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Hazard type label
        function hazardTypeLabel(type) {
            const labels = {
                'pothole': '–Ø–º–∞',
                'speed_bump': '–õ–µ–∂–∞—á–∏–π –ø–æ–ª–∏—Ü–µ–π—Å–∫–∏–π',
                'road_defect': '–î–µ—Ñ–µ–∫—Ç –ø–æ–∫—Ä—ã—Ç–∏—è'
            };
            return labels[type] || type;
        }

        // Severity badge
        function severityBadge(severity) {
            const classes = {
                'low': 'badge-info',
                'medium': 'badge-warning',
                'high': 'badge-danger'
            };
            const labels = {
                'low': '–ù–∏–∑–∫–∏–π',
                'medium': '–°—Ä–µ–¥–Ω–∏–π',
                'high': '–í—ã—Å–æ–∫–∏–π'
            };
            return `<span class="badge ${classes[severity] || 'badge-info'}">${labels[severity] || severity || 'N/A'}</span>`;
        }

        // Verified badge
        function verifiedBadge(verified) {
            return verified 
                ? '<span class="badge badge-success">‚úì –î–∞</span>' 
                : '<span class="badge badge-warning">‚óã –ù–µ—Ç</span>';
        }

        // Sort table
        function sortTable(column) {
            if (sortColumn === column) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = column;
                sortDirection = 'asc';
            }
            
            filteredData.sort((a, b) => {
                let aVal = a[column];
                let bVal = b[column];
                
                if (aVal === null || aVal === undefined) aVal = '';
                if (bVal === null || bVal === undefined) bVal = '';
                
                if (typeof aVal === 'string') {
                    aVal = aVal.toLowerCase();
                    bVal = bVal.toLowerCase();
                }
                
                if (sortDirection === 'asc') {
                    return aVal > bVal ? 1 : -1;
                } else {
                    return aVal < bVal ? 1 : -1;
                }
            });
            
            // Update sort indicators
            document.querySelectorAll('th').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
            });
            event.target.classList.add(`sort-${sortDirection}`);
            
            currentPage = 1;
            renderTable();
        }

        // Search table
        function searchTable() {
            const query = document.getElementById('searchInput').value.toLowerCase();
            
            if (!query) {
                filteredData = [...allData];
            } else {
                filteredData = allData.filter(row => {
                    return Object.values(row).some(val => 
                        String(val).toLowerCase().includes(query)
                    );
                });
            }
            
            currentPage = 1;
            renderTable();
        }

        // Change rows per page
        function changeRowsPerPage() {
            rowsPerPage = parseInt(document.getElementById('rowsPerPage').value);
            currentPage = 1;
            renderTable();
        }

        // Pagination
        function updatePagination() {
            const totalPages = Math.ceil(filteredData.length / rowsPerPage);
            const start = (currentPage - 1) * rowsPerPage + 1;
            const end = Math.min(currentPage * rowsPerPage, filteredData.length);
            
            document.getElementById('paginationInfo').textContent = 
                `–ü–æ–∫–∞–∑–∞–Ω–æ ${start}-${end} –∏–∑ ${filteredData.length}`;
            
            document.getElementById('prevBtn').disabled = currentPage === 1;
            document.getElementById('nextBtn').disabled = currentPage === totalPages || totalPages === 0;
            
            // Page numbers
            const pageNumbers = document.getElementById('pageNumbers');
            let pages = '';
            for (let i = 1; i <= Math.min(totalPages, 5); i++) {
                pages += `<button class="pagination-btn ${i === currentPage ? 'active' : ''}" onclick="goToPage(${i})">${i}</button>`;
            }
            if (totalPages > 5) {
                pages += '<span style="padding: 0.5rem;">...</span>';
                pages += `<button class="pagination-btn" onclick="goToPage(${totalPages})">${totalPages}</button>`;
            }
            pageNumbers.innerHTML = pages;
        }

        function changePage(direction) {
            currentPage += direction;
            renderTable();
        }

        function goToPage(page) {
            currentPage = page;
            renderTable();
        }

        // Select all checkbox
        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAll').checked;
            document.querySelectorAll('.row-checkbox').forEach(cb => {
                cb.checked = selectAll;
                if (selectAll) {
                    selectedRows.add(cb.dataset.id);
                } else {
                    selectedRows.delete(cb.dataset.id);
                }
            });
            updateBulkDeleteButton();
        }

        function updateSelectAll() {
            const checkboxes = document.querySelectorAll('.row-checkbox');
            const checked = document.querySelectorAll('.row-checkbox:checked');
            document.getElementById('selectAll').checked = checkboxes.length === checked.length;
            
            // Update selected rows
            selectedRows.clear();
            checked.forEach(cb => selectedRows.add(cb.dataset.id));
            updateBulkDeleteButton();
        }

        function updateBulkDeleteButton() {
            document.getElementById('bulkDeleteBtn').disabled = selectedRows.size === 0;
        }

        // Open edit modal
        function openEditModal(id) {
            const row = allData.find(r => r._id === id);
            if (!row) return;
            
            document.getElementById('edit-id').value = id;
            document.getElementById('edit-hazard-type').value = row.hazard_type || '';
            document.getElementById('edit-severity').value = row.severity || 'medium';
            document.getElementById('edit-verified').value = row.is_verified ? 'true' : 'false';
            document.getElementById('edit-notes').value = row.admin_notes || '';
            
            document.getElementById('editModal').classList.add('active');
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.remove('active');
        }

        // Save edit
        async function saveEdit() {
            const id = document.getElementById('edit-id').value;
            const data = {
                hazard_type: document.getElementById('edit-hazard-type').value || null,
                severity: document.getElementById('edit-severity').value,
                is_verified: document.getElementById('edit-verified').value === 'true',
                admin_notes: document.getElementById('edit-notes').value
            };
            
            try {
                const res = await fetch(`/api/admin/sensor-data/${id}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                if (!res.ok) throw new Error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
                
                closeEditModal();
                loadData();
                showNotification('–ó–∞–ø–∏—Å—å —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∞!', 'success');
            } catch (error) {
                showNotification('–û—à–∏–±–∫–∞: ' + error.message, 'error');
            }
        }

        // Delete row
        async function deleteRow(id) {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–ø–∏—Å—å?')) return;
            
            try {
                const res = await fetch(`/api/admin/sensor-data/${id}`, {
                    method: 'DELETE'
                });
                
                if (!res.ok) throw new Error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
                
                loadData();
                showNotification('–ó–∞–ø–∏—Å—å —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–∞!', 'success');
            } catch (error) {
                showNotification('–û—à–∏–±–∫–∞: ' + error.message, 'error');
            }
        }

        // Bulk delete
        async function openBulkDeleteModal() {
            if (selectedRows.size === 0) return;
            
            if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å ${selectedRows.size} –∑–∞–ø–∏—Å–µ–π?`)) return;
            
            try {
                for (const id of selectedRows) {
                    await fetch(`/api/admin/sensor-data/${id}`, { method: 'DELETE' });
                }
                
                selectedRows.clear();
                loadData();
                showNotification('–ó–∞–ø–∏—Å–∏ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω—ã!', 'success');
            } catch (error) {
                showNotification('–û—à–∏–±–∫–∞: ' + error.message, 'error');
            }
        }

        // Filters
        function toggleFilters() {
            document.getElementById('filtersPanel').classList.toggle('active');
        }

        function clearFilters() {
            document.getElementById('filter-date-from').value = '';
            document.getElementById('filter-date-to').value = '';
            document.getElementById('filter-hazard-type').value = '';
            document.getElementById('filter-verified').value = '';
        }

        async function previewBulkDelete() {
            const filters = {
                date_from: document.getElementById('filter-date-from').value || null,
                date_to: document.getElementById('filter-date-to').value || null,
                hazard_type: document.getElementById('filter-hazard-type').value || null,
                is_verified: document.getElementById('filter-verified').value ? 
                    document.getElementById('filter-verified').value === 'true' : null
            };
            
            try {
                const res = await fetch('/api/admin/sensor-data/count-by-filters', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(filters)
                });
                
                const result = await res.json();
                
                if (result.count === 0) {
                    showNotification('–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –ø–æ –∑–∞–¥–∞–Ω–Ω—ã–º —Ñ–∏–ª—å—Ç—Ä–∞–º', 'info');
                    return;
                }
                
                if (confirm(`–ë—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω–æ ${result.count} –∑–∞–ø–∏—Å–µ–π. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?`)) {
                    await bulkDeleteWithFilters(filters);
                }
            } catch (error) {
                showNotification('–û—à–∏–±–∫–∞: ' + error.message, 'error');
            }
        }

        async function bulkDeleteWithFilters(filters) {
            try {
                const res = await fetch('/api/admin/sensor-data/bulk', {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(filters)
                });
                
                const result = await res.json();
                
                clearFilters();
                toggleFilters();
                loadData();
                showNotification(`–£—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–æ ${result.deleted_count} –∑–∞–ø–∏—Å–µ–π!`, 'success');
            } catch (error) {
                showNotification('–û—à–∏–±–∫–∞: ' + error.message, 'error');
            }
        }

        // Export CSV
        async function exportCSV() {
            try {
                showNotification('–≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö...', 'info');
                window.location.href = '/api/admin/sensor-data/export/csv';
                setTimeout(() => {
                    showNotification('CSV —Ñ–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω!', 'success');
                }, 1000);
            } catch (error) {
                showNotification('–û—à–∏–±–∫–∞: ' + error.message, 'error');
            }
        }

        // Import Modal
        function openImportModal() {
            document.getElementById('importModal').classList.add('active');
        }

        function closeImportModal() {
            document.getElementById('importModal').classList.remove('active');
        }

        async function importCSV() {
            const fileInput = document.getElementById('csvFile');
            const file = fileInput.files[0];
            
            if (!file) {
                showNotification('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª', 'error');
                return;
            }
            
            const formData = new FormData();
            formData.append('file', file);
            
            try {
                showNotification('–ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö...', 'info');
                
                const res = await fetch('/api/admin/sensor-data/import/csv', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await res.json();
                
                closeImportModal();
                loadData();
                showNotification(`–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ ${result.imported_count} –∑–∞–ø–∏—Å–µ–π!`, 'success');
            } catch (error) {
                showNotification('–û—à–∏–±–∫–∞: ' + error.message, 'error');
            }
        }

        // Show notification
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            notification.className = `notification ${type} active`;
            document.getElementById('notificationMessage').textContent = message;
            
            setTimeout(() => {
                notification.classList.remove('active');
            }, 3000);
        }
    </script>
</body>
</html>
