<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Good Road Admin v2</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #0f172a;
            color: #e2e8f0;
            height: 100vh;
            overflow: hidden;
        }

        .header {
            background: #1e293b;
            padding: 1rem 2rem;
            border-bottom: 2px solid #334155;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 1.5rem;
            color: #60a5fa;
        }

        .header .subtitle {
            font-size: 0.875rem;
            color: #94a3b8;
            margin-top: 0.25rem;
        }

        .stats {
            display: flex;
            gap: 2rem;
        }

        .stat {
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #60a5fa;
        }

        .stat-label {
            font-size: 0.75rem;
            color: #94a3b8;
            margin-top: 0.25rem;
        }

        .container {
            display: flex;
            height: calc(100vh - 80px);
        }

        #map {
            flex: 1;
            height: 100%;
        }

        .sidebar {
            width: 350px;
            background: #1e293b;
            border-left: 2px solid #334155;
            overflow-y: auto;
            padding: 1rem;
        }

        .section {
            margin-bottom: 1.5rem;
        }

        .section-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: #94a3b8;
            text-transform: uppercase;
            margin-bottom: 0.75rem;
        }

        .filter-group {
            margin-bottom: 1rem;
        }

        .filter-group label {
            display: flex;
            align-items: center;
            padding: 0.5rem;
            border-radius: 0.375rem;
            cursor: pointer;
            transition: background 0.2s;
        }

        .filter-group label:hover {
            background: #334155;
        }

        .filter-group input[type="checkbox"] {
            margin-right: 0.5rem;
        }

        .event-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .event-item {
            background: #334155;
            padding: 0.75rem;
            border-radius: 0.375rem;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }

        .event-type {
            font-weight: 600;
            color: #60a5fa;
            margin-bottom: 0.25rem;
        }

        .event-details {
            color: #94a3b8;
            font-size: 0.75rem;
        }

        .severity-badge {
            display: inline-block;
            padding: 0.125rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 0.5rem;
        }

        .severity-1 { background: #dc2626; color: white; }
        .severity-2 { background: #ea580c; color: white; }
        .severity-3 { background: #f59e0b; color: white; }
        .severity-4 { background: #84cc16; color: white; }
        .severity-5 { background: #22c55e; color: white; }

        /* Leaflet marker colors */
        .marker-pothole { background-color: #dc2626; }
        .marker-braking { background-color: #ea580c; }
        .marker-bump { background-color: #f59e0b; }
        .marker-vibration { background-color: #a855f7; }
        .marker-accident { background-color: #ff0000; }
        .marker-normal { background-color: #22c55e; }

        .refresh-btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            cursor: pointer;
            font-weight: 600;
        }

        .refresh-btn:hover {
            background: #2563eb;
        }
    </style>
</head>
<body>
    <div class="header">
        <div>
            <h1>üõ£Ô∏è Good Road Admin v2</h1>
            <div class="subtitle">–ù–æ–≤–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ - ML –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è</div>
        </div>
        <div class="stats">
            <div class="stat">
                <div class="stat-value" id="raw-count">0</div>
                <div class="stat-label">–°—ã—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="event-count">0</div>
                <div class="stat-label">–°–æ–±—ã—Ç–∏–π</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="warning-count">0</div>
                <div class="stat-label">–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π</div>
            </div>
            <button class="refresh-btn" onclick="loadData()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
        </div>
    </div>

    <div class="container">
        <div id="map"></div>
        
        <div class="sidebar">
            <div class="section">
                <div class="section-title">–†–µ–∂–∏–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</div>
                <div style="margin-bottom: 1rem; padding: 0.75rem; background: #0f172a; border-radius: 6px;">
                    <label style="display: block; margin-bottom: 0.5rem; cursor: pointer;">
                        <input type="radio" name="viewMode" value="events" checked onchange="switchViewMode(this.value)">
                        <span style="margin-left: 0.5rem;">–°–æ–±—ã—Ç–∏—è (Events)</span>
                    </label>
                    <label style="display: block; cursor: pointer;">
                        <input type="radio" name="viewMode" value="rawData" onchange="switchViewMode(this.value)">
                        <span style="margin-left: 0.5rem;">–°—ã—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ (Raw Data)</span>
                    </label>
                </div>
                
                <div class="section-title" id="filter-title">–§–∏–ª—å—Ç—Ä—ã —Å–æ–±—ã—Ç–∏–π</div>
                <div class="filter-group">
                    <label>
                        <input type="checkbox" id="filter-pothole" checked onchange="filterEvents()">
                        <span>üï≥Ô∏è –Ø–º—ã</span>
                    </label>
                    <label>
                        <input type="checkbox" id="filter-braking" checked onchange="filterEvents()">
                        <span>üö® –¢–æ—Ä–º–æ–∂–µ–Ω–∏—è</span>
                    </label>
                    <label>
                        <input type="checkbox" id="filter-bump" checked onchange="filterEvents()">
                        <span>‚ö†Ô∏è –ù–µ—Ä–æ–≤–Ω–æ—Å—Ç–∏</span>
                    </label>
                    <label>
                        <input type="checkbox" id="filter-vibration" checked onchange="filterEvents()">
                        <span>„Ä∞Ô∏è –í–∏–±—Ä–∞—Ü–∏–∏</span>
                    </label>
                    <label>
                        <input type="checkbox" id="filter-accident" checked onchange="filterEvents()">
                        <span>üö® –ê–≤–∞—Ä–∏–∏</span>
                    </label>
                    <label>
                        <input type="checkbox" id="filter-normal" checked onchange="filterEvents()">
                        <span>‚úÖ –ù–æ—Ä–º–∞–ª—å–Ω—ã–µ</span>
                    </label>
                </div>
            </div>

            <div class="section">
                <div class="section-title">–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è</div>
                <div class="event-list" id="event-list">
                    <!-- –°–æ–±—ã—Ç–∏—è –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let map;
        let markers = [];
        let allEvents = [];
        let currentViewMode = 'events'; // üÜï –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π —Ä–µ–∂–∏–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã
        function initMap() {
            map = L.map('map').setView([55.7558, 37.6173], 12);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);
        }

        // –ü–æ–ª—É—á–∏—Ç—å —Ü–≤–µ—Ç –º–∞—Ä–∫–µ—Ä–∞ –ø–æ —Ç–∏–ø—É —Å–æ–±—ã—Ç–∏—è
        function getMarkerColor(eventType) {
            const colors = {
                'pothole': '#dc2626',
                'braking': '#ea580c',
                'bump': '#f59e0b',
                'vibration': '#a855f7',
                'accident': '#ff0000',
                'normal': '#22c55e'
            };
            return colors[eventType] || '#94a3b8';
        }

        // –ü–æ–ª—É—á–∏—Ç—å –∏–∫–æ–Ω–∫—É –ø–æ —Ç–∏–ø—É —Å–æ–±—ã—Ç–∏—è
        function getEventIcon(eventType) {
            const icons = {
                'pothole': 'üï≥Ô∏è',
                'braking': 'üö®',
                'bump': '‚ö†Ô∏è',
                'vibration': '„Ä∞Ô∏è',
                'accident': 'üö®',
                'normal': '‚úÖ'
            };
            return icons[eventType] || 'üìç';
        }

        // –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
        async function loadData() {
            try {
                // –ó–∞–≥—Ä—É–∑–∫–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
                const analyticsRes = await fetch('/api/admin/v2/analytics');
                const analytics = await analyticsRes.json();

                document.getElementById('raw-count').textContent = analytics.summary.raw_data_points || 0;
                document.getElementById('event-count').textContent = analytics.summary.processed_events || 0;
                document.getElementById('warning-count').textContent = analytics.summary.active_warnings || 0;

                // üÜï –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ —Ä–µ–∂–∏–º–∞
                if (currentViewMode === 'rawData') {
                    // –†–µ–∂–∏–º —Å—ã—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö - –æ–±–Ω–æ–≤–ª—è–µ–º raw data
                    await loadRawData();
                } else {
                    // –†–µ–∂–∏–º —Å–æ–±—ã—Ç–∏–π - –∑–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–±—ã—Ç–∏—è
                    const eventsRes = await fetch('/api/admin/v2/events?limit=500');
                    const eventsData = await eventsRes.json();
                    allEvents = eventsData.events || [];

                    // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π
                    displayEvents();
                    displayMarkers();
                }

            } catch (error) {
                console.error('Error loading data:', error);
                alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ' + error.message);
            }
        }

        // –û—Ç–æ–±—Ä–∞–∑–∏—Ç—å –º–∞—Ä–∫–µ—Ä—ã –Ω–∞ –∫–∞—Ä—Ç–µ
        function displayMarkers() {
            // –û—á–∏—Å—Ç–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –º–∞—Ä–∫–µ—Ä—ã
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];

            // –§–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å —Å–æ–±—ã—Ç–∏—è
            const filteredEvents = allEvents.filter(event => {
                const checkbox = document.getElementById(`filter-${event.eventType}`);
                return checkbox ? checkbox.checked : true;
            });

            // –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ –º–∞—Ä–∫–µ—Ä—ã
            filteredEvents.forEach(event => {
                if (event.latitude && event.longitude) {
                    const color = getMarkerColor(event.eventType);
                    const icon = getEventIcon(event.eventType);
                    
                    const marker = L.circleMarker([event.latitude, event.longitude], {
                        radius: 8,
                        fillColor: color,
                        color: '#fff',
                        weight: 2,
                        opacity: 1,
                        fillOpacity: 0.8
                    }).addTo(map);

                    const timestamp = new Date(event.timestamp).toLocaleString('ru-RU');
                    
                    marker.bindPopup(`
                        <div style="color: #1e293b;">
                            <h3>${icon} ${event.eventType}</h3>
                            <p><strong>Severity:</strong> ${event.severity}</p>
                            <p><strong>Confidence:</strong> ${(event.confidence * 100).toFixed(0)}%</p>
                            <p><strong>Speed:</strong> ${event.speed?.toFixed(1) || 0} –∫–º/—á</p>
                            <p><strong>Time:</strong> ${timestamp}</p>
                            <p><strong>GPS:</strong> ${event.latitude.toFixed(6)}, ${event.longitude.toFixed(6)}</p>
                        </div>
                    `);

                    markers.push(marker);
                }
            });

            // –¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ä—Ç—É –Ω–∞ –º–∞—Ä–∫–µ—Ä–∞—Ö
            if (markers.length > 0) {
                const group = new L.featureGroup(markers);
                map.fitBounds(group.getBounds().pad(0.1));
            }
        }

        // –û—Ç–æ–±—Ä–∞–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Å–æ–±—ã—Ç–∏–π
        function displayEvents() {
            const eventList = document.getElementById('event-list');
            
            const filteredEvents = allEvents.filter(event => {
                const checkbox = document.getElementById(`filter-${event.eventType}`);
                return checkbox ? checkbox.checked : true;
            }).slice(0, 20);

            eventList.innerHTML = filteredEvents.map(event => {
                const timestamp = new Date(event.timestamp).toLocaleString('ru-RU');
                const icon = getEventIcon(event.eventType);
                
                return `
                    <div class="event-item">
                        <div class="event-type">
                            ${icon} ${event.eventType}
                            <span class="severity-badge severity-${event.severity}">S${event.severity}</span>
                        </div>
                        <div class="event-details">
                            <div>–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: ${(event.confidence * 100).toFixed(0)}%</div>
                            <div>–°–∫–æ—Ä–æ—Å—Ç—å: ${event.speed?.toFixed(1) || 0} –∫–º/—á</div>
                            <div>${timestamp}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // –§–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å —Å–æ–±—ã—Ç–∏—è
        function filterEvents() {
            displayEvents();
            displayMarkers();
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ä–µ–∂–∏–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
        function switchViewMode(mode) {
            currentViewMode = mode; // üÜï –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º
            console.log('üìç –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω —Ä–µ–∂–∏–º:', mode);
            
            const filterTitle = document.getElementById('filter-title');
            const eventList = document.getElementById('event-list');
            
            if (mode === 'rawData') {
                filterTitle.textContent = '–§–∏–ª—å—Ç—Ä—ã —Å—ã—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö';
                loadRawData();
            } else {
                filterTitle.textContent = '–§–∏–ª—å—Ç—Ä—ã —Å–æ–±—ã—Ç–∏–π';
                displayEvents();
                displayMarkers();
            }
        }

        // üÜï –°–æ—Å—Ç–æ—è–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤ —Å—ã—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        let rawDataFilters = {
            limit: 1000,
            dateFrom: null,
            dateTo: null,
            timeFrom: null,
            timeTo: null,
            deviceId: null
        };
        
        // üÜï –û–±–Ω–æ–≤–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã —Å—ã—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        function updateRawDataFilters() {
            rawDataFilters.limit = parseInt(document.getElementById('raw-limit').value) || 1000;
            rawDataFilters.dateFrom = document.getElementById('raw-date-from').value || null;
            rawDataFilters.dateTo = document.getElementById('raw-date-to').value || null;
            rawDataFilters.timeFrom = document.getElementById('raw-time-from').value || null;
            rawDataFilters.timeTo = document.getElementById('raw-time-to').value || null;
            rawDataFilters.deviceId = document.getElementById('raw-device').value || null;
            
            console.log('üìä –ü—Ä–∏–º–µ–Ω–µ–Ω—ã —Ñ–∏–ª—å—Ç—Ä—ã:', rawDataFilters);
            loadRawData();
        }
        
        // üÜï –°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã
        function resetRawDataFilters() {
            document.getElementById('raw-limit').value = '1000';
            document.getElementById('raw-date-from').value = '';
            document.getElementById('raw-date-to').value = '';
            document.getElementById('raw-time-from').value = '';
            document.getElementById('raw-time-to').value = '';
            document.getElementById('raw-device').value = '';
            
            rawDataFilters = {
                limit: 1000,
                dateFrom: null,
                dateTo: null,
                timeFrom: null,
                timeTo: null,
                deviceId: null
            };
            
            loadRawData();
        }

        // –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏ –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—å —Å—ã—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ
        async function loadRawData() {
            try {
                // üÜï –°–æ–∑–¥–∞—ë–º —Ñ–∏–ª—å—Ç—Ä—ã UI –µ—Å–ª–∏ –∏—Ö –µ—â—ë –Ω–µ—Ç
                const filterTitle = document.getElementById('filter-title');
                if (!filterTitle.querySelector('#raw-filters-container')) {
                    filterTitle.innerHTML = `
                        <div id="raw-filters-container" style="width: 100%;">
                            <div style="font-size: 0.875rem; font-weight: 600; color: #94a3b8; text-transform: uppercase; margin-bottom: 1rem;">
                                –§–∏–ª—å—Ç—Ä—ã —Å—ã—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö
                            </div>
                            
                            <!-- –õ–∏–º–∏—Ç –∑–∞–ø–∏—Å–µ–π -->
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; font-size: 0.75rem; color: #94a3b8; margin-bottom: 0.5rem;">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π:</label>
                                <select id="raw-limit" onchange="updateRawDataFilters()" style="width: 100%; padding: 0.5rem; background: #0f172a; color: #e2e8f0; border: 1px solid #334155; border-radius: 4px;">
                                    <option value="100">100 —Ç–æ—á–µ–∫</option>
                                    <option value="500">500 —Ç–æ—á–µ–∫</option>
                                    <option value="1000" selected>1000 —Ç–æ—á–µ–∫</option>
                                    <option value="2000">2000 —Ç–æ—á–µ–∫</option>
                                    <option value="5000">5000 —Ç–æ—á–µ–∫</option>
                                    <option value="10000">10000 —Ç–æ—á–µ–∫</option>
                                </select>
                            </div>
                            
                            <!-- –§–∏–ª—å—Ç—Ä –ø–æ –¥–∞—Ç–µ -->
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; font-size: 0.75rem; color: #94a3b8; margin-bottom: 0.5rem;">–î–∞—Ç–∞ –æ—Ç:</label>
                                <input type="date" id="raw-date-from" onchange="updateRawDataFilters()" style="width: 100%; padding: 0.5rem; background: #0f172a; color: #e2e8f0; border: 1px solid #334155; border-radius: 4px;">
                            </div>
                            
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; font-size: 0.75rem; color: #94a3b8; margin-bottom: 0.5rem;">–î–∞—Ç–∞ –¥–æ:</label>
                                <input type="date" id="raw-date-to" onchange="updateRawDataFilters()" style="width: 100%; padding: 0.5rem; background: #0f172a; color: #e2e8f0; border: 1px solid #334155; border-radius: 4px;">
                            </div>
                            
                            <!-- –§–∏–ª—å—Ç—Ä –ø–æ –≤—Ä–µ–º–µ–Ω–∏ -->
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; font-size: 0.75rem; color: #94a3b8; margin-bottom: 0.5rem;">–í—Ä–µ–º—è –æ—Ç:</label>
                                <input type="time" id="raw-time-from" onchange="updateRawDataFilters()" style="width: 100%; padding: 0.5rem; background: #0f172a; color: #e2e8f0; border: 1px solid #334155; border-radius: 4px;">
                            </div>
                            
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; font-size: 0.75rem; color: #94a3b8; margin-bottom: 0.5rem;">–í—Ä–µ–º—è –¥–æ:</label>
                                <input type="time" id="raw-time-to" onchange="updateRawDataFilters()" style="width: 100%; padding: 0.5rem; background: #0f172a; color: #e2e8f0; border: 1px solid #334155; border-radius: 4px;">
                            </div>
                            
                            <!-- –§–∏–ª—å—Ç—Ä –ø–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤—É -->
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; font-size: 0.75rem; color: #94a3b8; margin-bottom: 0.5rem;">–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ (Device ID):</label>
                                <input type="text" id="raw-device" onchange="updateRawDataFilters()" placeholder="–í–≤–µ–¥–∏—Ç–µ Device ID..." style="width: 100%; padding: 0.5rem; background: #0f172a; color: #e2e8f0; border: 1px solid #334155; border-radius: 4px;">
                            </div>
                            
                            <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
                            <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                                <button onclick="updateRawDataFilters()" style="flex: 1; padding: 0.5rem; background: #60a5fa; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">
                                    –ü—Ä–∏–º–µ–Ω–∏—Ç—å
                                </button>
                                <button onclick="resetRawDataFilters()" style="flex: 1; padding: 0.5rem; background: #475569; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                    –°–±—Ä–æ—Å–∏—Ç—å
                                </button>
                            </div>
                        </div>
                    `;
                }
                
                // üÜï –°—Ç—Ä–æ–∏–º URL —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤
                let url = `/api/admin/v2/raw-data?limit=${rawDataFilters.limit}`;
                
                const response = await fetch(url);
                const result = await response.json();
                let rawData = result.data || [];
                
                // üÜï –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ (—Ç.–∫. backend API –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤—Å–µ —Ñ–∏–ª—å—Ç—Ä—ã)
                rawData = rawData.filter(item => {
                    // –§–∏–ª—å—Ç—Ä –ø–æ –¥–∞—Ç–µ
                    if (rawDataFilters.dateFrom) {
                        const itemDate = item.timestamp.split('T')[0];
                        if (itemDate < rawDataFilters.dateFrom) return false;
                    }
                    if (rawDataFilters.dateTo) {
                        const itemDate = item.timestamp.split('T')[0];
                        if (itemDate > rawDataFilters.dateTo) return false;
                    }
                    
                    // –§–∏–ª—å—Ç—Ä –ø–æ –≤—Ä–µ–º–µ–Ω–∏
                    if (rawDataFilters.timeFrom) {
                        const itemTime = item.timestamp.split('T')[1].substring(0, 5);
                        if (itemTime < rawDataFilters.timeFrom) return false;
                    }
                    if (rawDataFilters.timeTo) {
                        const itemTime = item.timestamp.split('T')[1].substring(0, 5);
                        if (itemTime > rawDataFilters.timeTo) return false;
                    }
                    
                    // –§–∏–ª—å—Ç—Ä –ø–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤—É
                    if (rawDataFilters.deviceId && !item.deviceId.includes(rawDataFilters.deviceId)) {
                        return false;
                    }
                    
                    return true;
                });
                
                console.log(`üìä –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${result.data.length} —Ç–æ—á–µ–∫, –ø–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤: ${rawData.length} –∏–∑ ${result.total}`);
                
                displayRawDataList(rawData);
                displayRawDataMarkers(rawData);
            } catch (error) {
                console.error('Error loading raw data:', error);
                alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—ã—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö: ' + error.message);
            }
        }

        // –û—Ç–æ–±—Ä–∞–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Å—ã—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        function displayRawDataList(rawData) {
            const eventList = document.getElementById('event-list');
            
            eventList.innerHTML = rawData.slice(0, 20).map(data => {
                const timestamp = new Date(data.timestamp).toLocaleString('ru-RU');
                
                return `
                    <div class="event-item">
                        <div class="event-type">
                            üìä Raw Data Point
                        </div>
                        <div class="event-details">
                            <div>Accel: X:${data.accelerometer_x?.toFixed(2) || 0}, Y:${data.accelerometer_y?.toFixed(2) || 0}, Z:${data.accelerometer_z?.toFixed(2) || 0}</div>
                            <div>Device: ${data.deviceId || 'Unknown'}</div>
                            <div>–°–∫–æ—Ä–æ—Å—Ç—å: ${data.speed?.toFixed(1) || 0} –∫–º/—á</div>
                            <div>${timestamp}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // –û—Ç–æ–±—Ä–∞–∑–∏—Ç—å –º–∞—Ä–∫–µ—Ä—ã —Å—ã—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö —Å —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏–µ–π
        let trajectoryLine = null;
        
        function displayRawDataMarkers(rawData) {
            // –û—á–∏—Å—Ç–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –º–∞—Ä–∫–µ—Ä—ã –∏ —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏—é
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];
            if (trajectoryLine) {
                map.removeLayer(trajectoryLine);
                trajectoryLine = null;
            }

            // –°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏–∏
            const sortedData = [...rawData].sort((a, b) => 
                new Date(a.timestamp) - new Date(b.timestamp)
            );

            // –°–æ–∑–¥–∞—Ç—å –º–∞—Å—Å–∏–≤ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –¥–ª—è —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏–∏
            const coordinates = sortedData
                .filter(data => data.latitude && data.longitude)
                .map(data => [data.latitude, data.longitude]);

            // –ù–∞—Ä–∏—Å–æ–≤–∞—Ç—å —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏—é (–ª–∏–Ω–∏—é)
            if (coordinates.length > 1) {
                trajectoryLine = L.polyline(coordinates, {
                    color: '#60a5fa',
                    weight: 3,
                    opacity: 0.7,
                    smoothFactor: 1
                }).addTo(map);
            }

            // –î–æ–±–∞–≤–∏—Ç—å –º–∞—Ä–∫–µ—Ä—ã –¥–ª—è —Ç–æ—á–µ–∫ –¥–∞–Ω–Ω—ã—Ö
            sortedData.forEach((data, index) => {
                if (data.latitude && data.longitude) {
                    // –ü–µ—Ä–≤–∞—è —Ç–æ—á–∫–∞ - –∑–µ–ª–µ–Ω–∞—è, –ø–æ—Å–ª–µ–¥–Ω—è—è - –∫—Ä–∞—Å–Ω–∞—è, –æ—Å—Ç–∞–ª—å–Ω—ã–µ - —Å–∏–Ω–∏–µ
                    let fillColor = '#94a3b8';
                    let radius = 5;
                    if (index === 0) {
                        fillColor = '#22c55e'; // –ó–µ–ª–µ–Ω—ã–π - —Å—Ç–∞—Ä—Ç
                        radius = 8;
                    } else if (index === sortedData.length - 1) {
                        fillColor = '#ef4444'; // –ö—Ä–∞—Å–Ω—ã–π - —Ñ–∏–Ω–∏—à
                        radius = 8;
                    }
                    
                    const marker = L.circleMarker([data.latitude, data.longitude], {
                        radius: radius,
                        fillColor: fillColor,
                        color: '#fff',
                        weight: 1,
                        opacity: 1,
                        fillOpacity: 0.7
                    }).addTo(map);

                    const timestamp = new Date(data.timestamp).toLocaleString('ru-RU');
                    const pointLabel = index === 0 ? 'üü¢ –°–¢–ê–†–¢' : 
                                      index === sortedData.length - 1 ? 'üî¥ –§–ò–ù–ò–®' : 
                                      `üìç –¢–æ—á–∫–∞ ${index + 1}`;
                    
                    marker.bindPopup(`
                        <div style="color: #1e293b;">
                            <h3>${pointLabel}</h3>
                            <p><strong>Device:</strong> ${data.deviceId || 'Unknown'}</p>
                            <p><strong>Accel:</strong> X:${data.accelerometer_x?.toFixed(2) || 0}, Y:${data.accelerometer_y?.toFixed(2) || 0}, Z:${data.accelerometer_z?.toFixed(2) || 0}</p>
                            <p><strong>Accel Count:</strong> ${data.accelerometer_count || 0} –∑–Ω–∞—á–µ–Ω–∏–π</p>
                            <p><strong>Speed:</strong> ${data.speed?.toFixed(1) || 0} –º/—Å (${(data.speed * 3.6)?.toFixed(1) || 0} –∫–º/—á)</p>
                            <p><strong>Accuracy:</strong> ${data.accuracy?.toFixed(1) || 0}m</p>
                            <p><strong>Time:</strong> ${timestamp}</p>
                            <p><strong>GPS:</strong> ${data.latitude.toFixed(6)}, ${data.longitude.toFixed(6)}</p>
                        </div>
                    `);

                    markers.push(marker);
                }
            });

            // –¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ä—Ç—É –Ω–∞ –º–∞—Ä–∫–µ—Ä–∞—Ö
            if (markers.length > 0) {
                const group = new L.featureGroup(markers);
                map.fitBounds(group.getBounds().pad(0.1));
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        initMap();
        loadData();

        // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
        setInterval(loadData, 30000);
    </script>
</body>
</html>
