<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Good Road Admin v2</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #0f172a;
            color: #e2e8f0;
            height: 100vh;
            overflow: hidden;
        }

        .header {
            background: #1e293b;
            padding: 1rem 2rem;
            border-bottom: 2px solid #334155;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 1.5rem;
            color: #60a5fa;
        }

        .header .subtitle {
            font-size: 0.875rem;
            color: #94a3b8;
            margin-top: 0.25rem;
        }

        .stats {
            display: flex;
            gap: 2rem;
        }

        .stat {
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #60a5fa;
        }

        .stat-label {
            font-size: 0.75rem;
            color: #94a3b8;
            margin-top: 0.25rem;
        }

        .container {
            display: flex;
            height: calc(100vh - 80px);
        }

        #map {
            flex: 1;
            height: 100%;
        }

        .sidebar {
            width: 350px;
            background: #1e293b;
            border-left: 2px solid #334155;
            overflow-y: auto;
            padding: 1rem;
        }

        .section {
            margin-bottom: 1.5rem;
        }

        .section-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: #94a3b8;
            text-transform: uppercase;
            margin-bottom: 0.75rem;
        }

        .filter-group {
            margin-bottom: 1rem;
        }

        .filter-group label {
            display: flex;
            align-items: center;
            padding: 0.5rem;
            border-radius: 0.375rem;
            cursor: pointer;
            transition: background 0.2s;
        }

        .filter-group label:hover {
            background: #334155;
        }

        .filter-group input[type="checkbox"] {
            margin-right: 0.5rem;
        }

        .event-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .event-item {
            background: #334155;
            padding: 0.75rem;
            border-radius: 0.375rem;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }

        .event-type {
            font-weight: 600;
            color: #60a5fa;
            margin-bottom: 0.25rem;
        }

        .event-details {
            color: #94a3b8;
            font-size: 0.75rem;
        }

        .severity-badge {
            display: inline-block;
            padding: 0.125rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 0.5rem;
        }

        .severity-1 { background: #dc2626; color: white; }
        .severity-2 { background: #ea580c; color: white; }
        .severity-3 { background: #f59e0b; color: white; }
        .severity-4 { background: #84cc16; color: white; }
        .severity-5 { background: #22c55e; color: white; }

        /* Leaflet marker colors */
        .marker-pothole { background-color: #dc2626; }
        .marker-braking { background-color: #ea580c; }
        .marker-bump { background-color: #f59e0b; }
        .marker-vibration { background-color: #a855f7; }
        .marker-accident { background-color: #ff0000; }
        .marker-normal { background-color: #22c55e; }

        .refresh-btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            cursor: pointer;
            font-weight: 600;
        }

        .refresh-btn:hover {
            background: #2563eb;
        }

        /* –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π */
        .action-btns {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .icon-btn {
            padding: 0.375rem 0.75rem;
            border: none;
            background: #475569;
            color: white;
            cursor: pointer;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            transition: all 0.2s;
        }

        .icon-btn:hover {
            background: #64748b;
        }

        .icon-btn.edit:hover {
            background: #3b82f6;
        }

        .icon-btn.delete:hover {
            background: #dc2626;
        }

        /* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(4px);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: #1e293b;
            border-radius: 12px;
            padding: 2rem;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            border: 1px solid #334155;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #334155;
        }

        .modal-header h2 {
            font-size: 1.5rem;
            color: #60a5fa;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #94a3b8;
            padding: 0.5rem;
            border-radius: 8px;
            transition: all 0.2s;
        }

        .close-btn:hover {
            background: #334155;
            color: #e2e8f0;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #cbd5e1;
            font-size: 0.875rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #334155;
            border-radius: 8px;
            font-size: 0.875rem;
            background: #0f172a;
            color: #e2e8f0;
            transition: all 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #60a5fa;
            box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .modal-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 2rem;
            padding-top: 1rem;
            border-top: 1px solid #334155;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
        }

        .btn-primary:hover {
            background: #2563eb;
        }

        .btn-secondary {
            background: #475569;
            color: white;
        }

        .btn-secondary:hover {
            background: #64748b;
        }

        .btn-danger {
            background: #dc2626;
            color: white;
        }

        .btn-danger:hover {
            background: #b91c1c;
        }

        .alert {
            padding: 1rem 1.5rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            position: fixed;
            top: 100px;
            right: 20px;
            z-index: 3000;
            max-width: 400px;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .alert-success {
            background: #065f46;
            color: #d1fae5;
            border: 1px solid #10b981;
        }

        .alert-error {
            background: #7f1d1d;
            color: #fee2e2;
            border: 1px solid #dc2626;
        }
    </style>
</head>
<body>
    <div class="header">
        <div>
            <h1>üõ£Ô∏è Good Road Admin v2</h1>
            <div class="subtitle">–ù–æ–≤–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ - ML –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è</div>
        </div>
        <div class="stats">
            <div class="stat">
                <div class="stat-value" id="raw-count">0</div>
                <div class="stat-label">–°—ã—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="event-count">0</div>
                <div class="stat-label">–°–æ–±—ã—Ç–∏–π</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="warning-count">0</div>
                <div class="stat-label">–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π</div>
            </div>
            <button class="refresh-btn" onclick="loadData()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
        </div>
    </div>

    <div class="container">
        <div id="map"></div>
        
        <div class="sidebar">
            <div class="section">
                <div class="section-title">–†–µ–∂–∏–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</div>
                <div style="margin-bottom: 1rem; padding: 0.75rem; background: #0f172a; border-radius: 6px;">
                    <label style="display: block; margin-bottom: 0.5rem; cursor: pointer;">
                        <input type="radio" name="viewMode" value="clusters" checked onchange="switchViewMode(this.value)">
                        <span style="margin-left: 0.5rem;">üéØ –ö–ª–∞—Å—Ç–µ—Ä—ã –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–π</span>
                    </label>
                    <label style="display: block; margin-bottom: 0.5rem; cursor: pointer;">
                        <input type="radio" name="viewMode" value="events" onchange="switchViewMode(this.value)">
                        <span style="margin-left: 0.5rem;">üìä –°–æ–±—ã—Ç–∏—è (Events)</span>
                    </label>
                    <label style="display: block; cursor: pointer;">
                        <input type="radio" name="viewMode" value="rawData" onchange="switchViewMode(this.value)">
                        <span style="margin-left: 0.5rem;">üìç –°—ã—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ (Raw Data)</span>
                    </label>
                </div>
                
                <div class="section-title" id="filter-title">–§–∏–ª—å—Ç—Ä—ã —Å–æ–±—ã—Ç–∏–π</div>
                <div class="filter-group">
                    <label>
                        <input type="checkbox" id="filter-pothole" checked onchange="filterEvents()">
                        <span>üï≥Ô∏è –Ø–º—ã</span>
                    </label>
                    <label>
                        <input type="checkbox" id="filter-braking" checked onchange="filterEvents()">
                        <span>üö® –¢–æ—Ä–º–æ–∂–µ–Ω–∏—è</span>
                    </label>
                    <label>
                        <input type="checkbox" id="filter-bump" checked onchange="filterEvents()">
                        <span>‚ö†Ô∏è –ù–µ—Ä–æ–≤–Ω–æ—Å—Ç–∏</span>
                    </label>
                    <label>
                        <input type="checkbox" id="filter-vibration" checked onchange="filterEvents()">
                        <span>„Ä∞Ô∏è –í–∏–±—Ä–∞—Ü–∏–∏</span>
                    </label>
                    <label>
                        <input type="checkbox" id="filter-accident" checked onchange="filterEvents()">
                        <span>üö® –ê–≤–∞—Ä–∏–∏</span>
                    </label>
                    <label>
                        <input type="checkbox" id="filter-normal" checked onchange="filterEvents()">
                        <span>‚úÖ –ù–æ—Ä–º–∞–ª—å–Ω—ã–µ</span>
                    </label>
                </div>
            </div>

            <div class="section">
                <div class="section-title">–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è</div>
                <div class="event-list" id="event-list">
                    <!-- –°–æ–±—ã—Ç–∏—è –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let map;
        let markers = [];
        let allEvents = [];
        let allClusters = []; // üÜï –•—Ä–∞–Ω–∏–ª–∏—â–µ –¥–ª—è –∫–ª–∞—Å—Ç–µ—Ä–æ–≤
        let currentViewMode = 'clusters'; // üÜï –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Ä–µ–∂–∏–º –∫–ª–∞—Å—Ç–µ—Ä–æ–≤

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã
        function initMap() {
            map = L.map('map').setView([55.7558, 37.6173], 12);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);
        }

        // –ü–æ–ª—É—á–∏—Ç—å —Ü–≤–µ—Ç –º–∞—Ä–∫–µ—Ä–∞ –ø–æ —Ç–∏–ø—É —Å–æ–±—ã—Ç–∏—è
        function getMarkerColor(eventType) {
            const colors = {
                'pothole': '#dc2626',
                'braking': '#ea580c',
                'bump': '#f59e0b',
                'vibration': '#a855f7',
                'accident': '#ff0000',
                'normal': '#22c55e'
            };
            return colors[eventType] || '#94a3b8';
        }

        // –ü–æ–ª—É—á–∏—Ç—å –∏–∫–æ–Ω–∫—É –ø–æ —Ç–∏–ø—É —Å–æ–±—ã—Ç–∏—è
        function getEventIcon(eventType) {
            const icons = {
                'pothole': 'üï≥Ô∏è',
                'braking': 'üö®',
                'bump': '‚ö†Ô∏è',
                'vibration': '„Ä∞Ô∏è',
                'accident': 'üö®',
                'normal': '‚úÖ'
            };
            return icons[eventType] || 'üìç';
        }

        // –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
        async function loadData() {
            try {
                // –ó–∞–≥—Ä—É–∑–∫–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
                const analyticsRes = await fetch('/api/admin/v2/analytics');
                const analytics = await analyticsRes.json();

                document.getElementById('raw-count').textContent = analytics.summary.raw_data_points || 0;
                document.getElementById('event-count').textContent = analytics.summary.processed_events || 0;
                document.getElementById('warning-count').textContent = analytics.summary.active_warnings || 0;

                // üÜï –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ —Ä–µ–∂–∏–º–∞
                if (currentViewMode === 'clusters') {
                    // –†–µ–∂–∏–º –∫–ª–∞—Å—Ç–µ—Ä–æ–≤ - –∑–∞–≥—Ä—É–∂–∞–µ–º –∫–ª–∞—Å—Ç–µ—Ä—ã
                    await loadClusters();
                } else if (currentViewMode === 'rawData') {
                    // –†–µ–∂–∏–º —Å—ã—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö - –æ–±–Ω–æ–≤–ª—è–µ–º raw data
                    await loadRawData();
                } else {
                    // –†–µ–∂–∏–º —Å–æ–±—ã—Ç–∏–π - –∑–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–±—ã—Ç–∏—è
                    const eventsRes = await fetch('/api/admin/v2/events?limit=500');
                    const eventsData = await eventsRes.json();
                    allEvents = eventsData.events || [];

                    // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π
                    displayEvents();
                    displayMarkers();
                }

            } catch (error) {
                console.error('Error loading data:', error);
                alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ' + error.message);
            }
        }

        // –û—Ç–æ–±—Ä–∞–∑–∏—Ç—å –º–∞—Ä–∫–µ—Ä—ã –Ω–∞ –∫–∞—Ä—Ç–µ
        function displayMarkers() {
            // –û—á–∏—Å—Ç–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –º–∞—Ä–∫–µ—Ä—ã
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];

            // –§–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å —Å–æ–±—ã—Ç–∏—è
            const filteredEvents = allEvents.filter(event => {
                const checkbox = document.getElementById(`filter-${event.eventType}`);
                return checkbox ? checkbox.checked : true;
            });

            // –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ –º–∞—Ä–∫–µ—Ä—ã
            filteredEvents.forEach(event => {
                if (event.latitude && event.longitude) {
                    const color = getMarkerColor(event.eventType);
                    const icon = getEventIcon(event.eventType);
                    
                    const marker = L.circleMarker([event.latitude, event.longitude], {
                        radius: 8,
                        fillColor: color,
                        color: '#fff',
                        weight: 2,
                        opacity: 1,
                        fillOpacity: 0.8
                    }).addTo(map);

                    const timestamp = new Date(event.timestamp).toLocaleString('ru-RU');
                    
                    marker.bindPopup(`
                        <div style="color: #1e293b;">
                            <h3>${icon} ${event.eventType}</h3>
                            <p><strong>Severity:</strong> ${event.severity}</p>
                            <p><strong>Confidence:</strong> ${(event.confidence * 100).toFixed(0)}%</p>
                            <p><strong>Speed:</strong> ${event.speed?.toFixed(1) || 0} –∫–º/—á</p>
                            <p><strong>Time:</strong> ${timestamp}</p>
                            <p><strong>GPS:</strong> ${event.latitude.toFixed(6)}, ${event.longitude.toFixed(6)}</p>
                        </div>
                    `);

                    markers.push(marker);
                }
            });

            // –¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ä—Ç—É –Ω–∞ –º–∞—Ä–∫–µ—Ä–∞—Ö
            if (markers.length > 0) {
                const group = new L.featureGroup(markers);
                map.fitBounds(group.getBounds().pad(0.1));
            }
        }

        // –û—Ç–æ–±—Ä–∞–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Å–æ–±—ã—Ç–∏–π
        function displayEvents() {
            const eventList = document.getElementById('event-list');
            
            const filteredEvents = allEvents.filter(event => {
                const checkbox = document.getElementById(`filter-${event.eventType}`);
                return checkbox ? checkbox.checked : true;
            }).slice(0, 20);

            eventList.innerHTML = filteredEvents.map(event => {
                const timestamp = new Date(event.timestamp).toLocaleString('ru-RU');
                const icon = getEventIcon(event.eventType);
                
                return `
                    <div class="event-item">
                        <div class="event-type">
                            ${icon} ${event.eventType}
                            <span class="severity-badge severity-${event.severity}">S${event.severity}</span>
                        </div>
                        <div class="event-details">
                            <div>–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: ${(event.confidence * 100).toFixed(0)}%</div>
                            <div>–°–∫–æ—Ä–æ—Å—Ç—å: ${event.speed?.toFixed(1) || 0} –∫–º/—á</div>
                            <div>${timestamp}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // –§–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å —Å–æ–±—ã—Ç–∏—è
        function filterEvents() {
            displayEvents();
            displayMarkers();
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ä–µ–∂–∏–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
        function switchViewMode(mode) {
            currentViewMode = mode; // üÜï –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º
            console.log('üìç –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω —Ä–µ–∂–∏–º:', mode);
            
            const filterTitle = document.getElementById('filter-title');
            const eventList = document.getElementById('event-list');
            
            if (mode === 'clusters') {
                filterTitle.textContent = '–§–∏–ª—å—Ç—Ä—ã –∫–ª–∞—Å—Ç–µ—Ä–æ–≤';
                loadClusters();
            } else if (mode === 'rawData') {
                filterTitle.textContent = '–§–∏–ª—å—Ç—Ä—ã —Å—ã—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö';
                loadRawData();
            } else {
                filterTitle.textContent = '–§–∏–ª—å—Ç—Ä—ã —Å–æ–±—ã—Ç–∏–π';
                displayEvents();
                displayMarkers();
            }
        }

        // üÜï –°–æ—Å—Ç–æ—è–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤ —Å—ã—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        let rawDataFilters = {
            limit: 10000, // –£–≤–µ–ª–∏—á–µ–Ω –ª–∏–º–∏—Ç, —Ç–µ–ø–µ—Ä—å —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π
            dateFrom: null,
            dateTo: null,
            timeFrom: null,
            timeTo: null,
            deviceId: null
        };
        
        // üÜï –û–±–Ω–æ–≤–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã —Å—ã—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        function updateRawDataFilters() {
            // –£–±—Ä–∞–Ω–∞ –ª–æ–≥–∏–∫–∞ –≤—ã–±–æ—Ä–∞ –ª–∏–º–∏—Ç–∞ - —Ç–µ–ø–µ—Ä—å —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π 10000
            rawDataFilters.dateFrom = document.getElementById('raw-date-from').value || null;
            rawDataFilters.dateTo = document.getElementById('raw-date-to').value || null;
            rawDataFilters.timeFrom = document.getElementById('raw-time-from').value || null;
            rawDataFilters.timeTo = document.getElementById('raw-time-to').value || null;
            rawDataFilters.deviceId = document.getElementById('raw-device').value || null;
            
            console.log('üìä –ü—Ä–∏–º–µ–Ω–µ–Ω—ã —Ñ–∏–ª—å—Ç—Ä—ã:', rawDataFilters);
            loadRawData();
        }
        
        // üÜï –°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã
        function resetRawDataFilters() {
            document.getElementById('raw-date-from').value = '';
            document.getElementById('raw-date-to').value = '';
            document.getElementById('raw-time-from').value = '';
            document.getElementById('raw-time-to').value = '';
            document.getElementById('raw-device').value = '';
            
            rawDataFilters = {
                limit: 10000,
                dateFrom: null,
                dateTo: null,
                timeFrom: null,
                timeTo: null,
                deviceId: null
            };
            
            loadRawData();
        }

        // –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏ –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—å —Å—ã—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ
        async function loadRawData() {
            try {
                // üÜï –°–æ–∑–¥–∞—ë–º —Ñ–∏–ª—å—Ç—Ä—ã UI –µ—Å–ª–∏ –∏—Ö –µ—â—ë –Ω–µ—Ç
                const filterTitle = document.getElementById('filter-title');
                if (!filterTitle.querySelector('#raw-filters-container')) {
                    filterTitle.innerHTML = `
                        <div id="raw-filters-container" style="width: 100%;">
                            <div style="font-size: 0.875rem; font-weight: 600; color: #94a3b8; text-transform: uppercase; margin-bottom: 1rem;">
                                –§–∏–ª—å—Ç—Ä—ã —Å—ã—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö
                            </div>
                            
                            <!-- –°—á–µ—Ç—á–∏–∫ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö -->
                            <div id="data-counter" style="margin-bottom: 1rem; padding: 1rem; background: #1e40af; border-radius: 8px; text-align: center;">
                                <div style="font-size: 0.75rem; color: #93c5fd; margin-bottom: 0.25rem;">–û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ –¥–∞–Ω–Ω—ã—Ö</div>
                                <div style="font-size: 1.5rem; font-weight: bold; color: #fff;">
                                    <span id="filtered-count">0</span> <span style="font-size: 1rem; color: #93c5fd;">–∏–∑</span> <span id="total-count">0</span>
                                </div>
                            </div>
                            
                            <!-- –§–∏–ª—å—Ç—Ä –ø–æ –¥–∞—Ç–µ -->
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; font-size: 0.75rem; color: #94a3b8; margin-bottom: 0.5rem;">–î–∞—Ç–∞ –æ—Ç:</label>
                                <input type="date" id="raw-date-from" onchange="updateRawDataFilters()" style="width: 100%; padding: 0.5rem; background: #0f172a; color: #e2e8f0; border: 1px solid #334155; border-radius: 4px;">
                            </div>
                            
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; font-size: 0.75rem; color: #94a3b8; margin-bottom: 0.5rem;">–î–∞—Ç–∞ –¥–æ:</label>
                                <input type="date" id="raw-date-to" onchange="updateRawDataFilters()" style="width: 100%; padding: 0.5rem; background: #0f172a; color: #e2e8f0; border: 1px solid #334155; border-radius: 4px;">
                            </div>
                            
                            <!-- –§–∏–ª—å—Ç—Ä –ø–æ –≤—Ä–µ–º–µ–Ω–∏ -->
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; font-size: 0.75rem; color: #94a3b8; margin-bottom: 0.5rem;">–í—Ä–µ–º—è –æ—Ç:</label>
                                <input type="time" id="raw-time-from" onchange="updateRawDataFilters()" style="width: 100%; padding: 0.5rem; background: #0f172a; color: #e2e8f0; border: 1px solid #334155; border-radius: 4px;">
                            </div>
                            
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; font-size: 0.75rem; color: #94a3b8; margin-bottom: 0.5rem;">–í—Ä–µ–º—è –¥–æ:</label>
                                <input type="time" id="raw-time-to" onchange="updateRawDataFilters()" style="width: 100%; padding: 0.5rem; background: #0f172a; color: #e2e8f0; border: 1px solid #334155; border-radius: 4px;">
                            </div>
                            
                            <!-- –§–∏–ª—å—Ç—Ä –ø–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤—É -->
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; font-size: 0.75rem; color: #94a3b8; margin-bottom: 0.5rem;">–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ (Device ID):</label>
                                <input type="text" id="raw-device" onchange="updateRawDataFilters()" placeholder="–í–≤–µ–¥–∏—Ç–µ Device ID..." style="width: 100%; padding: 0.5rem; background: #0f172a; color: #e2e8f0; border: 1px solid #334155; border-radius: 4px;">
                            </div>
                            
                            <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
                            <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                                <button onclick="updateRawDataFilters()" style="flex: 1; padding: 0.5rem; background: #60a5fa; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">
                                    –ü—Ä–∏–º–µ–Ω–∏—Ç—å
                                </button>
                                <button onclick="resetRawDataFilters()" style="flex: 1; padding: 0.5rem; background: #475569; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                    –°–±—Ä–æ—Å–∏—Ç—å
                                </button>
                            </div>
                        </div>
                    `;
                }
                
                // üÜï –°—Ç—Ä–æ–∏–º URL —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤
                let url = `/api/admin/v2/raw-data?limit=${rawDataFilters.limit}`;
                
                const response = await fetch(url);
                const result = await response.json();
                let rawData = result.data || [];
                
                // üÜï –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ (—Ç.–∫. backend API –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤—Å–µ —Ñ–∏–ª—å—Ç—Ä—ã)
                rawData = rawData.filter(item => {
                    // –§–∏–ª—å—Ç—Ä –ø–æ –¥–∞—Ç–µ
                    if (rawDataFilters.dateFrom) {
                        const itemDate = item.timestamp.split('T')[0];
                        if (itemDate < rawDataFilters.dateFrom) return false;
                    }
                    if (rawDataFilters.dateTo) {
                        const itemDate = item.timestamp.split('T')[0];
                        if (itemDate > rawDataFilters.dateTo) return false;
                    }
                    
                    // –§–∏–ª—å—Ç—Ä –ø–æ –≤—Ä–µ–º–µ–Ω–∏
                    if (rawDataFilters.timeFrom) {
                        const itemTime = item.timestamp.split('T')[1].substring(0, 5);
                        if (itemTime < rawDataFilters.timeFrom) return false;
                    }
                    if (rawDataFilters.timeTo) {
                        const itemTime = item.timestamp.split('T')[1].substring(0, 5);
                        if (itemTime > rawDataFilters.timeTo) return false;
                    }
                    
                    // –§–∏–ª—å—Ç—Ä –ø–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤—É
                    if (rawDataFilters.deviceId && !item.deviceId.includes(rawDataFilters.deviceId)) {
                        return false;
                    }
                    
                    return true;
                });
                
                console.log(`üìä –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${result.data.length} —Ç–æ—á–µ–∫, –ø–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤: ${rawData.length} –∏–∑ ${result.total}`);
                
                // üÜï –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫
                updateDataCounter(rawData.length, result.total);
                
                displayRawDataList(rawData);
                displayRawDataMarkers(rawData);
            } catch (error) {
                console.error('Error loading raw data:', error);
                alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—ã—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö: ' + error.message);
            }
        }
        
        // üÜï –û–±–Ω–æ–≤–∏—Ç—å —Å—á–µ—Ç—á–∏–∫ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        function updateDataCounter(filteredCount, totalCount) {
            const filteredElement = document.getElementById('filtered-count');
            const totalElement = document.getElementById('total-count');
            
            if (filteredElement && totalElement) {
                filteredElement.textContent = filteredCount;
                totalElement.textContent = totalCount;
            }
        }

        // –û—Ç–æ–±—Ä–∞–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Å—ã—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        function displayRawDataList(rawData) {
            const eventList = document.getElementById('event-list');
            
            // üÜï –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —Ñ–∏–ª—å—Ç—Ä–∞—Ö
            let filterInfo = `<div style="background: #334155; padding: 0.75rem; border-radius: 4px; margin-bottom: 1rem; font-size: 0.75rem; color: #94a3b8;">`;
            filterInfo += `üìä –ü–æ–∫–∞–∑–∞–Ω–æ: <strong style="color: #60a5fa;">${rawData.length}</strong> –∑–∞–ø–∏—Å–µ–π<br>`;
            
            if (rawDataFilters.dateFrom || rawDataFilters.dateTo) {
                filterInfo += `üìÖ –ü–µ—Ä–∏–æ–¥: ${rawDataFilters.dateFrom || '–Ω–∞—á–∞–ª–æ'} - ${rawDataFilters.dateTo || '—Å–µ–π—á–∞—Å'}<br>`;
            }
            if (rawDataFilters.timeFrom || rawDataFilters.timeTo) {
                filterInfo += `üïê –í—Ä–µ–º—è: ${rawDataFilters.timeFrom || '00:00'} - ${rawDataFilters.timeTo || '23:59'}<br>`;
            }
            if (rawDataFilters.deviceId) {
                filterInfo += `üì± –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ: ${rawDataFilters.deviceId}`;
            }
            filterInfo += `</div>`;
            
            eventList.innerHTML = filterInfo + rawData.slice(0, 50).map(data => {
                const timestamp = new Date(data.timestamp).toLocaleString('ru-RU');
                const accelMagnitude = Math.sqrt(
                    Math.pow(data.accelerometer_x || 0, 2) + 
                    Math.pow(data.accelerometer_y || 0, 2) + 
                    Math.pow(data.accelerometer_z || 0, 2)
                );
                
                return `
                    <div class="event-item" style="cursor: pointer;" onclick="map.setView([${data.latitude}, ${data.longitude}], 16);">
                        <div class="event-type" style="display: flex; justify-content: space-between; align-items: center;">
                            <span>üìä ${timestamp.split(',')[1].trim()}</span>
                            <span style="font-size: 0.75rem; color: #94a3b8;">${(data.speed * 3.6).toFixed(0)} –∫–º/—á</span>
                        </div>
                        <div class="event-details">
                            <div style="font-size: 0.7rem;">üìç ${data.latitude.toFixed(5)}, ${data.longitude.toFixed(5)}</div>
                            <div style="font-size: 0.7rem;">üìä Magnitude: ${accelMagnitude.toFixed(3)} –º/—Å¬≤</div>
                            <div style="font-size: 0.7rem;">üì± ${data.deviceId ? data.deviceId.substring(0, 20) + '...' : 'Unknown'}</div>
                            <div style="font-size: 0.65rem; color: #64748b; margin-top: 0.25rem;">${timestamp.split(',')[0]}</div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // üÜï –î–æ–±–∞–≤–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –µ—Å–ª–∏ –∑–∞–ø–∏—Å–µ–π –±–æ–ª—å—à–µ 50
            if (rawData.length > 50) {
                eventList.innerHTML += `
                    <div style="text-align: center; padding: 1rem; color: #64748b; font-size: 0.75rem;">
                        –ü–æ–∫–∞–∑–∞–Ω—ã –ø–µ—Ä–≤—ã–µ 50 –∏–∑ ${rawData.length} –∑–∞–ø–∏—Å–µ–π.<br>
                        –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–∞—Ä—Ç—É –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –≤—Å–µ—Ö —Ç–æ—á–µ–∫.
                    </div>
                `;
            }
        }

        // –û—Ç–æ–±—Ä–∞–∑–∏—Ç—å –º–∞—Ä–∫–µ—Ä—ã —Å—ã—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö —Å —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏–µ–π
        let trajectoryLine = null;
        
        function displayRawDataMarkers(rawData) {
            // –û—á–∏—Å—Ç–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –º–∞—Ä–∫–µ—Ä—ã –∏ —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏—é
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];
            if (trajectoryLine) {
                map.removeLayer(trajectoryLine);
                trajectoryLine = null;
            }

            // –°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏–∏
            const sortedData = [...rawData].sort((a, b) => 
                new Date(a.timestamp) - new Date(b.timestamp)
            );

            // –°–æ–∑–¥–∞—Ç—å –º–∞—Å—Å–∏–≤ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –¥–ª—è —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏–∏
            const coordinates = sortedData
                .filter(data => data.latitude && data.longitude)
                .map(data => [data.latitude, data.longitude]);

            // –ù–∞—Ä–∏—Å–æ–≤–∞—Ç—å —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏—é (–ª–∏–Ω–∏—é)
            if (coordinates.length > 1) {
                trajectoryLine = L.polyline(coordinates, {
                    color: '#60a5fa',
                    weight: 3,
                    opacity: 0.7,
                    smoothFactor: 1
                }).addTo(map);
            }

            // –î–æ–±–∞–≤–∏—Ç—å –º–∞—Ä–∫–µ—Ä—ã –¥–ª—è —Ç–æ—á–µ–∫ –¥–∞–Ω–Ω—ã—Ö
            sortedData.forEach((data, index) => {
                if (data.latitude && data.longitude) {
                    // –ü–µ—Ä–≤–∞—è —Ç–æ—á–∫–∞ - –∑–µ–ª–µ–Ω–∞—è, –ø–æ—Å–ª–µ–¥–Ω—è—è - –∫—Ä–∞—Å–Ω–∞—è, –æ—Å—Ç–∞–ª—å–Ω—ã–µ - —Å–∏–Ω–∏–µ
                    let fillColor = '#94a3b8';
                    let radius = 5;
                    if (index === 0) {
                        fillColor = '#22c55e'; // –ó–µ–ª–µ–Ω—ã–π - —Å—Ç–∞—Ä—Ç
                        radius = 8;
                    } else if (index === sortedData.length - 1) {
                        fillColor = '#ef4444'; // –ö—Ä–∞—Å–Ω—ã–π - —Ñ–∏–Ω–∏—à
                        radius = 8;
                    }
                    
                    const marker = L.circleMarker([data.latitude, data.longitude], {
                        radius: radius,
                        fillColor: fillColor,
                        color: '#fff',
                        weight: 1,
                        opacity: 1,
                        fillOpacity: 0.7
                    }).addTo(map);

                    const timestamp = new Date(data.timestamp).toLocaleString('ru-RU');
                    const pointLabel = index === 0 ? 'üü¢ –°–¢–ê–†–¢' : 
                                      index === sortedData.length - 1 ? 'üî¥ –§–ò–ù–ò–®' : 
                                      `üìç –¢–æ—á–∫–∞ ${index + 1}`;
                    
                    marker.bindPopup(`
                        <div style="color: #1e293b;">
                            <h3>${pointLabel}</h3>
                            <p><strong>Device:</strong> ${data.deviceId || 'Unknown'}</p>
                            <p><strong>Accel:</strong> X:${data.accelerometer_x?.toFixed(2) || 0}, Y:${data.accelerometer_y?.toFixed(2) || 0}, Z:${data.accelerometer_z?.toFixed(2) || 0}</p>
                            <p><strong>Accel Count:</strong> ${data.accelerometer_count || 0} –∑–Ω–∞—á–µ–Ω–∏–π</p>
                            <p><strong>Speed:</strong> ${data.speed?.toFixed(1) || 0} –º/—Å (${(data.speed * 3.6)?.toFixed(1) || 0} –∫–º/—á)</p>
                            <p><strong>Accuracy:</strong> ${data.accuracy?.toFixed(1) || 0}m</p>
                            <p><strong>Time:</strong> ${timestamp}</p>
                            <p><strong>GPS:</strong> ${data.latitude.toFixed(6)}, ${data.longitude.toFixed(6)}</p>
                        </div>
                    `);

                    markers.push(marker);
                }
            });

            // –¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ä—Ç—É –Ω–∞ –º–∞—Ä–∫–µ—Ä–∞—Ö
            if (markers.length > 0) {
                const group = new L.featureGroup(markers);
                map.fitBounds(group.getBounds().pad(0.1));
            }
        }

        // üÜï –ó–∞–≥—Ä—É–∑–∏—Ç—å –∫–ª–∞—Å—Ç–µ—Ä—ã –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–π
        async function loadClusters() {
            try {
                console.log('üìä –ó–∞–≥—Ä—É–∑–∫–∞ –∫–ª–∞—Å—Ç–µ—Ä–æ–≤...');
                
                const response = await fetch('/api/admin/v2/clusters?limit=1000&status=active');
                const result = await response.json();
                
                allClusters = result.clusters || [];
                
                console.log(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${allClusters.length} –∫–ª–∞—Å—Ç–µ—Ä–æ–≤`);
                
                displayClusters();
                displayClusterMarkers();
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–ª–∞—Å—Ç–µ—Ä–æ–≤:', error);
                alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–ª–∞—Å—Ç–µ—Ä–æ–≤: ' + error.message);
            }
        }

        // üÜï –û—Ç–æ–±—Ä–∞–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∫–ª–∞—Å—Ç–µ—Ä–æ–≤
        function displayClusters() {
            const eventList = document.getElementById('event-list');
            
            if (allClusters.length === 0) {
                eventList.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #64748b;">
                        <h3>–ö–ª–∞—Å—Ç–µ—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h3>
                        <p style="font-size: 0.875rem; margin-top: 0.5rem;">
                            –ü–æ–∫–∞ –Ω–µ—Ç –æ–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã—Ö –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–π.<br>
                            –ù–∞—á–Ω–∏—Ç–µ —Å–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è –∫–ª–∞—Å—Ç–µ—Ä–æ–≤.
                        </p>
                    </div>
                `;
                return;
            }
            
            eventList.innerHTML = allClusters.slice(0, 50).map(cluster => {
                const lastReportedDate = new Date(cluster.lastReported).toLocaleString('ru-RU');
                const icon = getEventIcon(cluster.obstacleType);
                const confirmationClass = cluster.reportCount >= 3 ? 'severity-1' : 
                                         cluster.reportCount === 2 ? 'severity-3' : 'severity-5';
                
                return `
                    <div class="event-item" style="cursor: pointer;" 
                         onclick="map.setView([${cluster.location.latitude}, ${cluster.location.longitude}], 16);">
                        <div class="event-type" style="display: flex; justify-content: space-between; align-items: center;">
                            <span>${icon} ${cluster.obstacleType}</span>
                            <span class="severity-badge ${confirmationClass}">
                                ${cluster.reportCount} ${cluster.reportCount === 1 ? '–æ—Ç—á–µ—Ç' : '–æ—Ç—á–µ—Ç–∞'}
                            </span>
                        </div>
                        <div class="event-details">
                            <div>–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: ${(cluster.confidence * 100).toFixed(0)}%</div>
                            <div>–°—Ä–µ–¥–Ω—è—è —Å–µ—Ä—å–µ–∑–Ω–æ—Å—Ç—å: ${cluster.severity.average.toFixed(1)}</div>
                            <div>–£—Å—Ç—Ä–æ–π—Å—Ç–≤: ${cluster.devices.length}</div>
                            <div style="font-size: 0.7rem; color: #64748b; margin-top: 0.25rem;">
                                –ü–æ—Å–ª–µ–¥–Ω–∏–π: ${lastReportedDate}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            if (allClusters.length > 50) {
                eventList.innerHTML += `
                    <div style="text-align: center; padding: 1rem; color: #64748b; font-size: 0.75rem;">
                        –ü–æ–∫–∞–∑–∞–Ω—ã –ø–µ—Ä–≤—ã–µ 50 –∏–∑ ${allClusters.length} –∫–ª–∞—Å—Ç–µ—Ä–æ–≤.<br>
                        –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–∞—Ä—Ç—É –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –≤—Å–µ—Ö.
                    </div>
                `;
            }
        }

        // üÜï –û—Ç–æ–±—Ä–∞–∑–∏—Ç—å –º–∞—Ä–∫–µ—Ä—ã –∫–ª–∞—Å—Ç–µ—Ä–æ–≤ –Ω–∞ –∫–∞—Ä—Ç–µ
        function displayClusterMarkers() {
            // –û—á–∏—Å—Ç–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –º–∞—Ä–∫–µ—Ä—ã –∏ —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏—é
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];
            if (trajectoryLine) {
                map.removeLayer(trajectoryLine);
                trajectoryLine = null;
            }

            allClusters.forEach(cluster => {
                if (cluster.location && cluster.location.latitude && cluster.location.longitude) {
                    const color = getMarkerColor(cluster.obstacleType);
                    const icon = getEventIcon(cluster.obstacleType);
                    
                    // –†–∞–∑–º–µ—Ä –º–∞—Ä–∫–µ—Ä–∞ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–π
                    const radius = Math.min(8 + cluster.reportCount * 2, 20);
                    
                    const marker = L.circleMarker(
                        [cluster.location.latitude, cluster.location.longitude], 
                        {
                            radius: radius,
                            fillColor: color,
                            color: '#fff',
                            weight: 3,
                            opacity: 1,
                            fillOpacity: 0.8
                        }
                    ).addTo(map);

                    const firstReportedDate = new Date(cluster.firstReported).toLocaleString('ru-RU');
                    const lastReportedDate = new Date(cluster.lastReported).toLocaleString('ru-RU');
                    
                    marker.bindPopup(`
                        <div style="color: #1e293b; min-width: 250px;">
                            <h3 style="margin: 0 0 0.5rem 0; display: flex; align-items: center; gap: 0.5rem;">
                                ${icon} ${cluster.obstacleType}
                                <span style="background: ${color}; color: white; padding: 0.125rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem;">
                                    x${cluster.reportCount}
                                </span>
                            </h3>
                            <p style="margin: 0.25rem 0;"><strong>–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å:</strong> ${(cluster.confidence * 100).toFixed(0)}%</p>
                            <p style="margin: 0.25rem 0;"><strong>–°–µ—Ä—å–µ–∑–Ω–æ—Å—Ç—å:</strong> ${cluster.severity.average.toFixed(1)} (–º–∏–Ω: ${cluster.severity.min}, –º–∞–∫—Å: ${cluster.severity.max})</p>
                            <p style="margin: 0.25rem 0;"><strong>–°—Ä–µ–¥–Ω—è—è —Å–∫–æ—Ä–æ—Å—Ç—å:</strong> ${(cluster.roadInfo.avgSpeed * 3.6).toFixed(1)} –∫–º/—á</p>
                            <p style="margin: 0.25rem 0;"><strong>–£—Å—Ç—Ä–æ–π—Å—Ç–≤:</strong> ${cluster.devices.length}</p>
                            <p style="margin: 0.25rem 0; font-size: 0.75rem; color: #64748b;">
                                <strong>–ü–µ—Ä–≤—ã–π –æ—Ç—á–µ—Ç:</strong><br>${firstReportedDate}
                            </p>
                            <p style="margin: 0.25rem 0; font-size: 0.75rem; color: #64748b;">
                                <strong>–ü–æ—Å–ª–µ–¥–Ω–∏–π –æ—Ç—á–µ—Ç:</strong><br>${lastReportedDate}
                            </p>
                            <p style="margin: 0.5rem 0 0 0; font-size: 0.75rem;">
                                <strong>GPS:</strong> ${cluster.location.latitude.toFixed(6)}, ${cluster.location.longitude.toFixed(6)}
                            </p>
                        </div>
                    `);

                    markers.push(marker);
                }
            });

            // –¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ä—Ç—É –Ω–∞ –º–∞—Ä–∫–µ—Ä–∞—Ö
            if (markers.length > 0) {
                const group = new L.featureGroup(markers);
                map.fitBounds(group.getBounds().pad(0.1));
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        initMap();
        loadData();

        // üÜï –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥ (—Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º —Ñ–∏–ª—å—Ç—Ä–æ–≤ –∏ —Ä–µ–∂–∏–º–∞)
        setInterval(() => {
            console.log('üîÑ –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ... –†–µ–∂–∏–º:', currentViewMode);
            loadData();
        }, 30000);
    </script>
</body>
</html>
