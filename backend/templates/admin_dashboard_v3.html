<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Good Road Admin v3 - –ö–∞—Ä—Ç–∞ + –†–µ–¥–∞–∫—Ç–æ—Ä</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #0f172a; color: #e2e8f0; height: 100vh; overflow: hidden; }
        .header { background: #1e293b; padding: 1rem 2rem; border-bottom: 2px solid #334155; display: flex; justify-content: space-between; align-items: center; }
        .header h1 { font-size: 1.5rem; color: #60a5fa; }
        .stats { display: flex; gap: 1.5rem; align-items: center; }
        .stat-value { font-size: 1.25rem; font-weight: bold; color: #60a5fa; }
        .stat-label { font-size: 0.75rem; color: #94a3b8; }
        .btn { padding: 0.5rem 1rem; border: none; border-radius: 0.5rem; cursor: pointer; font-weight: 600; transition: all 0.2s; }
        .btn-primary { background: #3b82f6; color: white; }
        .btn-primary:hover { background: #2563eb; }
        .btn-danger { background: #dc2626; color: white; }
        .btn-danger:hover { background: #b91c1c; }
        .view-toggle { display: flex; gap: 0.5rem; background: #0f172a; padding: 0.25rem; border-radius: 0.5rem; }
        .view-toggle button { padding: 0.5rem 1rem; border: none; background: transparent; color: #94a3b8; cursor: pointer; border-radius: 0.375rem; font-weight: 600; }
        .view-toggle button.active { background: #3b82f6; color: white; }
        .container { display: flex; height: calc(100vh - 70px); }
        #map { flex: 1; }
        .panel { width: 400px; background: #1e293b; border-left: 2px solid #334155; overflow-y: auto; padding: 1rem; }
        .table-container { display: none; padding: 2rem; overflow: auto; }
        .table-container.active { display: block; flex: 1; }
        table { width: 100%; border-collapse: collapse; }
        thead { background: #1e293b; position: sticky; top: 0; }
        th { padding: 0.75rem; text-align: left; color: #cbd5e1; border-bottom: 2px solid #334155; }
        td { padding: 0.75rem; border-bottom: 1px solid #334155; }
        tbody tr:hover { background: #334155; }
        .checkbox { width: 18px; height: 18px; cursor: pointer; }
        .severity-badge { padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; font-weight: 600; }
        .severity-1 { background: #dc2626; color: white; }
        .severity-2 { background: #ea580c; color: white; }
        .icon-btn { padding: 0.375rem 0.75rem; border: none; background: #475569; color: white; cursor: pointer; border-radius: 0.25rem; font-size: 0.75rem; }
        .icon-btn:hover { background: #3b82f6; }
        .action-btns { display: flex; gap: 0.5rem; }
        .bulk-actions { display: none; gap: 1rem; padding: 1rem; background: #1e293b; border-radius: 0.5rem; margin-bottom: 1rem; }
        .bulk-actions.active { display: flex; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: #1e293b; border-radius: 12px; padding: 2rem; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid #334155; }
        .modal-header h2 { color: #60a5fa; }
        .close-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #94a3b8; }
        .form-group { margin-bottom: 1.5rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; color: #cbd5e1; font-size: 0.875rem; font-weight: 600; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 0.75rem; border: 1px solid #334155; border-radius: 8px; background: #0f172a; color: #e2e8f0; }
        .form-group textarea { min-height: 100px; }
        .modal-actions { display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem; }
        .alert { padding: 1rem; border-radius: 8px; position: fixed; top: 100px; right: 20px; z-index: 3000; }
        .alert-success { background: #065f46; color: #d1fae5; }
        .alert-error { background: #7f1d1d; color: #fee2e2; }
    </style>
</head>
<body>
    <div class="header">
        <div>
            <h1>üõ£Ô∏è Good Road Admin v3</h1>
        </div>
        <div class="stats">
            <div class="view-toggle">
                <button class="active" id="map-view-btn" onclick="toggleView('map')">üó∫Ô∏è –ö–∞—Ä—Ç–∞</button>
                <button id="table-view-btn" onclick="toggleView('table')">üìã –¢–∞–±–ª–∏—Ü–∞</button>
            </div>
            <div class="stat">
                <div class="stat-value" id="event-count">0</div>
                <div class="stat-label">–°–æ–±—ã—Ç–∏–π</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="cluster-count">0</div>
                <div class="stat-label">–ö–ª–∞—Å—Ç–µ—Ä–æ–≤</div>
            </div>
            <button class="btn btn-primary" onclick="loadData()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
        </div>
    </div>

    <div class="container">
        <div id="map-container" style="flex: 1; display: flex;">
            <div id="map" style="flex: 1;"></div>
            <div class="panel">
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; cursor: pointer;">
                        <input type="radio" name="viewMode" value="events" checked onchange="switchDataMode(this.value)">
                        <span style="margin-left: 0.5rem;">üìä –°–æ–±—ã—Ç–∏—è</span>
                    </label>
                    <label style="display: block; cursor: pointer;">
                        <input type="radio" name="viewMode" value="clusters" onchange="switchDataMode(this.value)">
                        <span style="margin-left: 0.5rem;">üéØ –ö–ª–∞—Å—Ç–µ—Ä—ã</span>
                    </label>
                </div>
                <div id="panel-content"></div>
            </div>
        </div>

        <div class="table-container" id="table-container">
            <div class="bulk-actions" id="bulk-actions">
                <span style="color: #cbd5e1;">–í—ã–±—Ä–∞–Ω–æ: <span id="selected-count">0</span></span>
                <button class="btn btn-danger" onclick="bulkDelete()">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
            </div>
            <div id="table-content"></div>
        </div>
    </div>

    <div class="modal" id="edit-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</h2>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <form id="edit-form"></form>
        </div>
    </div>

    <div id="alerts-container"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let map, allEvents = [], allClusters = [], currentMode = 'events', selectedIds = new Set();

        initMap();
        loadData();

        function initMap() {
            map = L.map('map').setView([55.7558, 37.6173], 12);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        }

        async function loadData() {
            try {
                const [eventsRes, clustersRes] = await Promise.all([
                    fetch('/api/admin/v2/events?limit=1000'),
                    fetch('/api/admin/v2/clusters?limit=1000')
                ]);
                const eventsData = await eventsRes.json();
                const clustersData = await clustersRes.json();
                allEvents = eventsData.events || [];
                allClusters = clustersData.clusters || [];
                document.getElementById('event-count').textContent = allEvents.length;
                document.getElementById('cluster-count').textContent = allClusters.length;
                renderData();
            } catch (error) {
                showAlert('error', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + error.message);
            }
        }

        function switchDataMode(mode) {
            currentMode = mode;
            renderData();
        }

        function toggleView(view) {
            document.getElementById('map-view-btn').classList.toggle('active', view === 'map');
            document.getElementById('table-view-btn').classList.toggle('active', view === 'table');
            document.getElementById('map-container').style.display = view === 'map' ? 'flex' : 'none';
            document.getElementById('table-container').classList.toggle('active', view === 'table');
            if (view === 'table') renderTable();
        }

        function renderData() {
            map.eachLayer(l => { if (l instanceof L.Marker) map.removeLayer(l); });
            const data = currentMode === 'events' ? allEvents : allClusters;
            data.forEach(item => {
                const coords = currentMode === 'events' 
                    ? [item.latitude, item.longitude]
                    : [item.location.latitude, item.location.longitude];
                L.marker(coords).addTo(map).bindPopup(`
                    <b>${currentMode === 'events' ? item.eventType : item.obstacleType}</b><br>
                    –°–µ—Ä—å–µ–∑–Ω–æ—Å—Ç—å: ${currentMode === 'events' ? item.severity : item.severity?.max}<br>
                    <button onclick="editItem('${currentMode === 'events' ? item.id : item.clusterId}', '${currentMode}')" style="margin-top: 0.5rem; padding: 0.25rem 0.5rem; border: none; background: #3b82f6; color: white; border-radius: 0.25rem; cursor: pointer;">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                `);
            });
            renderPanel();
        }

        function renderPanel() {
            const content = document.getElementById('panel-content');
            const data = (currentMode === 'events' ? allEvents : allClusters).slice(0, 20);
            content.innerHTML = data.map(item => `
                <div style="background: #334155; padding: 0.75rem; border-radius: 0.5rem; margin-bottom: 0.5rem;">
                    <div style="font-weight: 600; color: #60a5fa;">${currentMode === 'events' ? item.eventType : item.obstacleType}</div>
                    <div style="font-size: 0.75rem; color: #94a3b8; margin-top: 0.25rem;">
                        –°–µ—Ä—å–µ–∑–Ω–æ—Å—Ç—å: ${currentMode === 'events' ? item.severity : item.severity?.max}<br>
                        –£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: ${(item.confidence * 100).toFixed(0)}%
                    </div>
                    <div class="action-btns" style="margin-top: 0.5rem;">
                        <button class="icon-btn" onclick="editItem('${currentMode === 'events' ? item.id : item.clusterId}', '${currentMode}')">‚úèÔ∏è</button>
                        <button class="icon-btn" onclick="deleteItem('${currentMode === 'events' ? item.id : item.clusterId}', '${currentMode}')">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');
        }

        function renderTable() {
            const content = document.getElementById('table-content');
            const data = currentMode === 'events' ? allEvents : allClusters;
            content.innerHTML = `<table>
                <thead><tr>
                    <th><input type="checkbox" class="checkbox" onchange="toggleSelectAll(this)"></th>
                    <th>–¢–∏–ø</th><th>–°–µ—Ä—å–µ–∑–Ω–æ—Å—Ç—å</th><th>–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å</th><th>–í—Ä–µ–º—è</th><th>–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã</th><th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr></thead>
                <tbody>${data.map(item => {
                    const id = currentMode === 'events' ? item.id : item.clusterId;
                    return `<tr>
                        <td><input type="checkbox" class="checkbox" value="${id}" onchange="toggleSelect(this)"></td>
                        <td>${currentMode === 'events' ? item.eventType : item.obstacleType}</td>
                        <td><span class="severity-badge severity-${currentMode === 'events' ? item.severity : item.severity?.max}">${currentMode === 'events' ? item.severity : item.severity?.max}</span></td>
                        <td>${(item.confidence * 100).toFixed(0)}%</td>
                        <td>${new Date(currentMode === 'events' ? item.timestamp : item.lastReported).toLocaleString('ru-RU')}</td>
                        <td>${currentMode === 'events' ? item.latitude?.toFixed(4) : item.location?.latitude?.toFixed(4)}, ${currentMode === 'events' ? item.longitude?.toFixed(4) : item.location?.longitude?.toFixed(4)}</td>
                        <td><div class="action-btns">
                            <button class="icon-btn" onclick="editItem('${id}', '${currentMode}')">‚úèÔ∏è</button>
                            <button class="icon-btn" onclick="deleteItem('${id}', '${currentMode}')">üóëÔ∏è</button>
                        </div></td>
                    </tr>`;
                }).join('')}</tbody>
            </table>`;
        }

        function toggleSelect(cb) {
            if (cb.checked) selectedIds.add(cb.value);
            else selectedIds.delete(cb.value);
            document.getElementById('bulk-actions').classList.toggle('active', selectedIds.size > 0);
            document.getElementById('selected-count').textContent = selectedIds.size;
        }

        function toggleSelectAll(cb) {
            document.querySelectorAll('tbody input[type="checkbox"]').forEach(c => {
                c.checked = cb.checked;
                if (cb.checked) selectedIds.add(c.value);
                else selectedIds.delete(c.value);
            });
            document.getElementById('bulk-actions').classList.toggle('active', selectedIds.size > 0);
            document.getElementById('selected-count').textContent = selectedIds.size;
        }

        function editItem(id, type) {
            const item = type === 'events' ? allEvents.find(e => e.id === id) : allClusters.find(c => c.clusterId === id);
            if (!item) return;
            document.getElementById('modal-title').textContent = type === 'events' ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–±—ã—Ç–∏–µ' : '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–ª–∞—Å—Ç–µ—Ä';
            document.getElementById('edit-form').innerHTML = type === 'events' ? `
                <div class="form-group"><label>–¢–∏–ø</label><select id="edit-type">
                    <option value="pothole" ${item.eventType === 'pothole' ? 'selected' : ''}>–Ø–º–∞</option>
                    <option value="bump" ${item.eventType === 'bump' ? 'selected' : ''}>–ù–µ—Ä–æ–≤–Ω–æ—Å—Ç—å</option>
                </select></div>
                <div class="form-group"><label>–°–µ—Ä—å–µ–∑–Ω–æ—Å—Ç—å</label><input type="number" id="edit-severity" min="1" max="5" value="${item.severity}"></div>
                <div class="form-group"><label>–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å</label><input type="number" id="edit-confidence" step="0.01" min="0" max="1" value="${item.confidence}"></div>
                <div class="form-group"><label>–ó–∞–º–µ—Ç–∫–∏</label><textarea id="edit-notes">${item.notes || ''}</textarea></div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-primary" onclick="saveEdit('${id}', 'events')">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            ` : `
                <div class="form-group"><label>–¢–∏–ø</label><select id="edit-type">
                    <option value="pothole" ${item.obstacleType === 'pothole' ? 'selected' : ''}>–Ø–º–∞</option>
                    <option value="bump" ${item.obstacleType === 'bump' ? 'selected' : ''}>–ù–µ—Ä–æ–≤–Ω–æ—Å—Ç—å</option>
                </select></div>
                <div class="form-group"><label>–ú–∞–∫—Å. —Å–µ—Ä—å–µ–∑–Ω–æ—Å—Ç—å</label><input type="number" id="edit-severity-max" min="1" max="5" value="${item.severity?.max || 5}"></div>
                <div class="form-group"><label>–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å</label><input type="number" id="edit-confidence" step="0.01" min="0" max="1" value="${item.confidence}"></div>
                <div class="form-group"><label>–°—Ç–∞—Ç—É—Å</label><select id="edit-status">
                    <option value="active" ${item.status === 'active' ? 'selected' : ''}>–ê–∫—Ç–∏–≤–Ω—ã–π</option>
                    <option value="expired" ${item.status === 'expired' ? 'selected' : ''}>–ò—Å—Ç—ë–∫—à–∏–π</option>
                </select></div>
                <div class="form-group"><label>–ó–∞–º–µ—Ç–∫–∏</label><textarea id="edit-notes">${item.notes || ''}</textarea></div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-primary" onclick="saveEdit('${id}', 'clusters')">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            `;
            document.getElementById('edit-modal').classList.add('active');
        }

        async function saveEdit(id, type) {
            try {
                const body = type === 'events' ? {
                    eventType: document.getElementById('edit-type').value,
                    severity: parseInt(document.getElementById('edit-severity').value),
                    confidence: parseFloat(document.getElementById('edit-confidence').value),
                    notes: document.getElementById('edit-notes').value
                } : {
                    obstacleType: document.getElementById('edit-type').value,
                    severity_max: parseInt(document.getElementById('edit-severity-max').value),
                    confidence: parseFloat(document.getElementById('edit-confidence').value),
                    status: document.getElementById('edit-status').value,
                    notes: document.getElementById('edit-notes').value
                };
                const res = await fetch(`/api/admin/editor/${type}/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                if (res.ok) {
                    showAlert('success', '‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
                    closeModal();
                    loadData();
                } else {
                    const error = await res.json();
                    showAlert('error', '–û—à–∏–±–∫–∞: ' + error.detail);
                }
            } catch (error) {
                showAlert('error', '–û—à–∏–±–∫–∞: ' + error.message);
            }
        }

        async function deleteItem(id, type) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —ç–ª–µ–º–µ–Ω—Ç?')) return;
            try {
                const res = await fetch(`/api/admin/editor/${type}/${id}`, { method: 'DELETE' });
                if (res.ok) {
                    showAlert('success', '‚úÖ –£–¥–∞–ª–µ–Ω–æ');
                    loadData();
                } else {
                    showAlert('error', '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
                }
            } catch (error) {
                showAlert('error', '–û—à–∏–±–∫–∞: ' + error.message);
            }
        }

        async function bulkDelete() {
            if (!confirm(`–£–¥–∞–ª–∏—Ç—å ${selectedIds.size} —ç–ª–µ–º–µ–Ω—Ç–æ–≤?`)) return;
            try {
                const res = await fetch(`/api/admin/editor/${currentMode}/bulk-delete`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ids: Array.from(selectedIds) })
                });
                if (res.ok) {
                    showAlert('success', '‚úÖ –£–¥–∞–ª–µ–Ω–æ ' + selectedIds.size);
                    selectedIds.clear();
                    loadData();
                } else {
                    showAlert('error', '–û—à–∏–±–∫–∞ –º–∞—Å—Å–æ–≤–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è');
                }
            } catch (error) {
                showAlert('error', '–û—à–∏–±–∫–∞: ' + error.message);
            }
        }

        function closeModal() {
            document.getElementById('edit-modal').classList.remove('active');
        }

        function showAlert(type, message) {
            const container = document.getElementById('alerts-container');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            container.appendChild(alert);
            setTimeout(() => alert.remove(), 3000);
        }
    </script>
</body>
</html>