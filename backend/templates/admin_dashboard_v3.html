<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Good Road Admin v3 - –ö–∞—Ä—Ç–∞ + –†–µ–¥–∞–∫—Ç–æ—Ä</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #0f172a; color: #e2e8f0; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        .header { background: #1e293b; padding: 1rem 2rem; border-bottom: 2px solid #334155; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .header h1 { font-size: 1.5rem; color: #60a5fa; }
        .stats { display: flex; gap: 1.5rem; align-items: center; }
        .stat { text-align: center; }
        .stat-value { font-size: 1.25rem; font-weight: bold; color: #60a5fa; }
        .stat-label { font-size: 0.75rem; color: #94a3b8; }
        .btn { padding: 0.5rem 1rem; border: none; border-radius: 0.5rem; cursor: pointer; font-weight: 600; transition: all 0.2s; }
        .btn-primary { background: #3b82f6; color: white; }
        .btn-primary:hover { background: #2563eb; }
        .btn-danger { background: #dc2626; color: white; }
        .btn-danger:hover { background: #b91c1c; }
        .btn-secondary { background: #475569; color: white; }
        .btn-secondary:hover { background: #64748b; }
        
        .main-content { display: flex; flex: 1; overflow: hidden; }
        .map-section { flex: 1; display: flex; flex-direction: column; }
        #map { flex: 1; }
        
        .data-panel { width: 450px; background: #1e293b; border-left: 2px solid #334155; display: flex; flex-direction: column; }
        .panel-header { padding: 1rem; border-bottom: 2px solid #334155; }
        .panel-controls { display: flex; gap: 0.5rem; margin-bottom: 1rem; }
        .panel-controls label { display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; background: #0f172a; border-radius: 0.5rem; cursor: pointer; font-size: 0.875rem; }
        .panel-controls input[type="radio"] { cursor: pointer; }
        .panel-controls input[type="radio"]:checked + span { color: #60a5fa; font-weight: 600; }
        
        .filters { display: flex; flex-direction: column; gap: 0.5rem; }
        .filter-row { display: flex; gap: 0.5rem; }
        .filter-input { flex: 1; padding: 0.5rem; background: #0f172a; border: 1px solid #334155; border-radius: 0.5rem; color: #e2e8f0; font-size: 0.875rem; }
        .filter-input:focus { outline: none; border-color: #60a5fa; }
        .filter-input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(1); }
        .select-all-row { display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: #0f172a; border-radius: 0.5rem; margin-top: 0.5rem; }
        .select-all-row label { font-size: 0.875rem; cursor: pointer; user-select: none; }
        
        .data-list { flex: 1; overflow-y: auto; padding: 1rem; }
        .data-item { background: #0f172a; padding: 1rem; border-radius: 0.5rem; margin-bottom: 0.75rem; border: 1px solid #334155; }
        .data-item:hover { border-color: #475569; }
        .item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
        .item-type { font-weight: 600; color: #60a5fa; font-size: 0.875rem; }
        .item-details { font-size: 0.75rem; color: #94a3b8; line-height: 1.6; }
        .item-actions { display: flex; gap: 0.5rem; margin-top: 0.75rem; }
        .icon-btn { padding: 0.375rem 0.75rem; border: none; background: #475569; color: white; cursor: pointer; border-radius: 0.375rem; font-size: 0.75rem; transition: all 0.2s; }
        .icon-btn.edit:hover { background: #3b82f6; }
        .icon-btn.delete:hover { background: #dc2626; }
        
        .severity-badge { padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; font-weight: 600; }
        .severity-1 { background: #dc2626; color: white; }
        .severity-2 { background: #ea580c; color: white; }
        .severity-3 { background: #f59e0b; color: white; }
        .severity-4 { background: #10b981; color: white; }
        .severity-5 { background: #3b82f6; color: white; }
        
        .bulk-actions { padding: 1rem; background: #0f172a; border-radius: 0.5rem; margin-bottom: 1rem; display: none; }
        .bulk-actions.active { display: flex; gap: 1rem; align-items: center; }
        
        .checkbox { width: 18px; height: 18px; cursor: pointer; }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: #1e293b; border-radius: 12px; padding: 2rem; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid #334155; }
        .modal-header h2 { color: #60a5fa; }
        .close-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #94a3b8; }
        .close-btn:hover { color: #e2e8f0; }
        .form-group { margin-bottom: 1.5rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; color: #cbd5e1; font-size: 0.875rem; font-weight: 600; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 0.75rem; border: 1px solid #334155; border-radius: 8px; background: #0f172a; color: #e2e8f0; }
        .form-group textarea { min-height: 100px; resize: vertical; }
        .modal-actions { display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem; }
        .alert { padding: 1rem; border-radius: 8px; position: fixed; top: 100px; right: 20px; z-index: 3000; max-width: 400px; }
        .alert-success { background: #065f46; color: #d1fae5; }
        .alert-error { background: #7f1d1d; color: #fee2e2; }
        
        .empty-state { text-align: center; padding: 3rem 1rem; color: #64748b; }
        .empty-state-icon { font-size: 3rem; margin-bottom: 1rem; opacity: 0.5; }
    </style>
</head>
<body>
    <div class="header">
        <div>
            <h1>üõ£Ô∏è Good Road Admin v3</h1>
        </div>
        <div class="stats">
            <div class="stat">
                <div class="stat-value" id="event-count">0</div>
                <div class="stat-label" title="–û—Ç–¥–µ–ª—å–Ω—ã–µ –¥–µ—Ç–µ–∫—Ü–∏–∏ –æ—Ç –∫–∞–∂–¥–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞">–°–æ–±—ã—Ç–∏–π</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="cluster-count">0</div>
                <div class="stat-label" title="–ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ —Å–æ–±—ã—Ç–∏–π –ø–æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—é">–ö–ª–∞—Å—Ç–µ—Ä–æ–≤</div>
            </div>
            <button class="btn btn-primary" onclick="showHelp()" title="–ü–æ–∫–∞–∑–∞—Ç—å —Å–ø—Ä–∞–≤–∫—É" style="margin-right: 0.5rem;">‚ùì</button>
            <button class="btn btn-primary" onclick="loadData()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
        </div>
    </div>

    <div class="main-content">
        <div class="map-section">
            <div id="map"></div>
        </div>

        <div class="data-panel">
            <div class="panel-header">
                <div class="panel-controls">
                    <label>
                        <input type="radio" name="viewMode" value="events" checked onchange="switchDataMode(this.value)">
                        <span>üìä –°–æ–±—ã—Ç–∏—è</span>
                    </label>
                    <label>
                        <input type="radio" name="viewMode" value="clusters" onchange="switchDataMode(this.value)">
                        <span>üéØ –ö–ª–∞—Å—Ç–µ—Ä—ã</span>
                    </label>
                </div>
                
                <div class="filters">
                    <input type="text" class="filter-input" id="search-filter" placeholder="üîç –ü–æ–∏—Å–∫..." oninput="applyFilters()">
                    <div class="filter-row">
                        <select class="filter-input" id="type-filter" onchange="applyFilters()">
                            <option value="">–í—Å–µ —Ç–∏–ø—ã</option>
                            <option value="pothole">–Ø–º—ã</option>
                            <option value="bump">–ù–µ—Ä–æ–≤–Ω–æ—Å—Ç–∏</option>
                            <option value="speed_bump">–õ–µ–∂–∞—á–∏–µ</option>
                            <option value="vibration">–í–∏–±—Ä–∞—Ü–∏—è</option>
                            <option value="braking">–¢–æ—Ä–º–æ–∂–µ–Ω–∏–µ</option>
                        </select>
                        <select class="filter-input" id="severity-filter" onchange="applyFilters()">
                            <option value="">–°–µ—Ä—å–µ–∑–Ω–æ—Å—Ç—å</option>
                            <option value="1">1 - –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è</option>
                            <option value="2">2 - –í—ã—Å–æ–∫–∞—è</option>
                            <option value="3">3 - –°—Ä–µ–¥–Ω—è—è</option>
                            <option value="4">4 - –ù–∏–∑–∫–∞—è</option>
                            <option value="5">5 - –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è</option>
                        </select>
                    </div>
                    <div class="filter-row">
                        <input type="date" class="filter-input" id="date-from-filter" onchange="applyFilters()" title="–î–∞—Ç–∞ –æ—Ç">
                        <input type="date" class="filter-input" id="date-to-filter" onchange="applyFilters()" title="–î–∞—Ç–∞ –¥–æ">
                    </div>
                    <div class="select-all-row">
                        <input type="checkbox" id="select-all-checkbox" class="checkbox" onchange="selectAllFiltered(this.checked)">
                        <label for="select-all-checkbox">–í—ã–±—Ä–∞—Ç—å –≤—Å–µ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–µ (<span id="filtered-count">0</span>)</label>
                    </div>
                </div>
                
                <div class="bulk-actions" id="bulk-actions">
                    <span style="color: #cbd5e1; font-size: 0.875rem;">–í—ã–±—Ä–∞–Ω–æ: <span id="selected-count">0</span></span>
                    <button class="btn btn-danger" onclick="bulkDelete()">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
                </div>
            </div>

            <div class="data-list" id="data-list"></div>
        </div>
    </div>

    <div class="modal" id="edit-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</h2>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <form id="edit-form"></form>
        </div>
    </div>

    <div class="modal" id="help-modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2>‚ùì –°–ø—Ä–∞–≤–∫–∞ - –°–æ–±—ã—Ç–∏—è vs –ö–ª–∞—Å—Ç–µ—Ä—ã</h2>
                <button class="close-btn" onclick="closeHelpModal()">&times;</button>
            </div>
            <div style="color: #cbd5e1; line-height: 1.8;">
                <h3 style="color: #60a5fa; margin-top: 1rem;">üìä –°–æ–±—ã—Ç–∏—è (Events)</h3>
                <p style="margin: 0.5rem 0;">
                    <strong>–û—Ç–¥–µ–ª—å–Ω—ã–µ –¥–µ—Ç–µ–∫—Ü–∏–∏ –æ—Ç –∫–∞–∂–¥–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞:</strong>
                </p>
                <ul style="margin-left: 1.5rem; margin-bottom: 1rem;">
                    <li>–ö–∞–∂–¥—ã–π –ø—Ä–æ–µ–∑–¥ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ —á–µ—Ä–µ–∑ –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–µ = –Ω–æ–≤–æ–µ —Å–æ–±—ã—Ç–∏–µ</li>
                    <li>–û–¥–Ω–∞ –∏ —Ç–∞ –∂–µ —è–º–∞ –º–æ–∂–µ—Ç —Å–æ–∑–¥–∞—Ç—å <strong>10 —Å–æ–±—ã—Ç–∏–π</strong> (–æ—Ç —Ä–∞–∑–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)</li>
                    <li>–°–æ–±—ã—Ç–∏—è = "—Å—ã—Ä—ã–µ" –¥–∞–Ω–Ω—ã–µ –æ—Ç –∫–∞–∂–¥–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</li>
                    <li>–°–æ–¥–µ—Ä–∂–∞—Ç: —Ç–∏–ø, —Å–µ—Ä—å–µ–∑–Ω–æ—Å—Ç—å, –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã, –≤—Ä–µ–º—è, ID —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</li>
                </ul>

                <h3 style="color: #60a5fa; margin-top: 1.5rem;">üéØ –ö–ª–∞—Å—Ç–µ—Ä—ã (Clusters)</h3>
                <p style="margin: 0.5rem 0;">
                    <strong>–ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ —Å–æ–±—ã—Ç–∏–π –ø–æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—é:</strong>
                </p>
                <ul style="margin-left: 1.5rem; margin-bottom: 1rem;">
                    <li>–ï—Å–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–æ–±—ã—Ç–∏–π –ø—Ä–æ–∏–∑–æ—à–ª–∏ –≤ —Ä–∞–¥–∏—É—Å–µ <strong>~10 –º–µ—Ç—Ä–æ–≤</strong> ‚Üí —Å–æ–∑–¥–∞—ë—Ç—Å—è 1 –∫–ª–∞—Å—Ç–µ—Ä</li>
                    <li>–ö–ª–∞—Å—Ç–µ—Ä = "–ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω–Ω–æ–µ" –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–µ</li>
                    <li>–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç <strong>reportCount</strong> - —Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ –æ –Ω—ë–º —Å–æ–æ–±—â–∏–ª–∏</li>
                    <li>–°–æ–¥–µ—Ä–∂–∞—Ç: —Ç–∏–ø, —Å—Ä–µ–¥–Ω—è—è —Å–µ—Ä—å–µ–∑–Ω–æ—Å—Ç—å, —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç—á—ë—Ç–æ–≤</li>
                </ul>

                <div style="background: #0f172a; padding: 1rem; border-radius: 8px; margin: 1rem 0; border-left: 4px solid #60a5fa;">
                    <strong style="color: #60a5fa;">üîç –ü—Ä–∏–º–µ—Ä:</strong><br><br>
                    <strong>–°–∏—Ç—É–∞—Ü–∏—è:</strong> 10 –≤–æ–¥–∏—Ç–µ–ª–µ–π –ø—Ä–æ–µ—Ö–∞–ª–∏ —á–µ—Ä–µ–∑ —è–º—É –Ω–∞ —É–ª–∏—Ü–µ –©–µ–ª–∫–æ–ª–æ–≤–∞<br><br>
                    <strong>–†–µ–∑—É–ª—å—Ç–∞—Ç:</strong><br>
                    ‚Üí <strong>10 —Å–æ–±—ã—Ç–∏–π</strong> (–∫–∞–∂–¥–æ–µ –æ—Ç –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞)<br>
                    ‚Üí <strong>1 –∫–ª–∞—Å—Ç–µ—Ä</strong> (—è–º–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞ 10 —Ä–∞–∑, reportCount=10)
                </div>

                <h3 style="color: #60a5fa; margin-top: 1.5rem;">üí° –ö–æ–≥–¥–∞ —á—Ç–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å?</h3>
                <ul style="margin-left: 1.5rem;">
                    <li><strong>–°–æ–±—ã—Ç–∏—è:</strong> –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –¥–µ—Ç–µ–∫—Ü–∏–π, –¥–µ–±–∞–≥–∞, –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–±–æ—Ç—ã ML</li>
                    <li><strong>–ö–ª–∞—Å—Ç–µ—Ä—ã:</strong> –¥–ª—è –ø–æ–∫–∞–∑–∞ –Ω–∞ –∫–∞—Ä—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º, —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏, "—Ä–µ–∞–ª—å–Ω—ã—Ö" –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–π</li>
                </ul>

                <h3 style="color: #60a5fa; margin-top: 1.5rem;">‚öôÔ∏è –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞?</h3>
                <p style="margin: 0.5rem 0;">
                    –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç —Å–æ–±—ã—Ç–∏—è –≤ –∫–ª–∞—Å—Ç–µ—Ä—ã –ø–æ —Å–ª–µ–¥—É—é—â–∏–º –ø—Ä–∞–≤–∏–ª–∞–º:
                </p>
                <ul style="margin-left: 1.5rem;">
                    <li>–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –º–µ–∂–¥—É —Å–æ–±—ã—Ç–∏—è–º–∏ < 10 –º–µ—Ç—Ä–æ–≤</li>
                    <li>–û–¥–∏–Ω–∞–∫–æ–≤—ã–π —Ç–∏–ø –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è (—è–º–∞, –Ω–µ—Ä–æ–≤–Ω–æ—Å—Ç—å, –ª–µ–∂–∞—á–∏–π)</li>
                    <li>–°–æ–±—ã—Ç–∏—è –Ω–µ —Å—Ç–∞—Ä—à–µ 30 –¥–Ω–µ–π</li>
                    <li>–ú–∏–Ω–∏–º—É–º 1 —Å–æ–±—ã—Ç–∏–µ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–ª–∞—Å—Ç–µ—Ä–∞</li>
                </ul>
            </div>
            <div style="margin-top: 1.5rem; text-align: center;">
                <button class="btn btn-primary" onclick="closeHelpModal()">–ü–æ–Ω—è—Ç–Ω–æ</button>
            </div>
        </div>
    </div>

    <div id="alerts-container"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let map, allEvents = [], allClusters = [], filteredData = [], currentMode = 'events', selectedIds = new Set();

        initMap();
        loadData();

        function initMap() {
            map = L.map('map').setView([55.7558, 37.6173], 12);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap'
            }).addTo(map);
        }

        async function loadData() {
            try {
                const [eventsRes, clustersRes] = await Promise.all([
                    fetch('/api/admin/v2/events?limit=1000'),
                    fetch('/api/admin/v2/clusters?limit=1000&min_reports=3')  // üÜï –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω–Ω—ã–µ –∫–ª–∞—Å—Ç–µ—Ä—ã (‚â•3 –æ—Ç—á—ë—Ç–∞)
                ]);
                const eventsData = await eventsRes.json();
                const clustersData = await clustersRes.json();
                allEvents = eventsData.events || [];
                allClusters = clustersData.clusters || [];
                document.getElementById('event-count').textContent = allEvents.length;
                document.getElementById('cluster-count').textContent = allClusters.length;
                applyFilters();
            } catch (error) {
                showAlert('error', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + error.message);
            }
        }

        function switchDataMode(mode) {
            currentMode = mode;
            selectedIds.clear();
            applyFilters();
        }

        function applyFilters() {
            const searchText = document.getElementById('search-filter').value.toLowerCase();
            const typeFilter = document.getElementById('type-filter').value;
            const severityFilter = document.getElementById('severity-filter').value;
            const dateFromFilter = document.getElementById('date-from-filter').value;
            const dateToFilter = document.getElementById('date-to-filter').value;
            
            const data = currentMode === 'events' ? allEvents : allClusters;
            
            filteredData = data.filter(item => {
                const itemType = currentMode === 'events' ? item.eventType : item.obstacleType;
                const itemSeverity = currentMode === 'events' ? item.severity : item.severity?.max;
                const itemDate = currentMode === 'events' ? item.timestamp : item.lastReported;
                
                const searchMatch = !searchText || 
                    JSON.stringify(item).toLowerCase().includes(searchText);
                const typeMatch = !typeFilter || itemType === typeFilter;
                const severityMatch = !severityFilter || itemSeverity === parseInt(severityFilter);
                
                // –§–∏–ª—å—Ç—Ä –ø–æ –¥–∞—Ç–µ
                let dateMatch = true;
                if (dateFromFilter || dateToFilter) {
                    const itemDateObj = new Date(itemDate);
                    if (dateFromFilter) {
                        const fromDateObj = new Date(dateFromFilter);
                        fromDateObj.setHours(0, 0, 0, 0);
                        dateMatch = dateMatch && itemDateObj >= fromDateObj;
                    }
                    if (dateToFilter) {
                        const toDateObj = new Date(dateToFilter);
                        toDateObj.setHours(23, 59, 59, 999);
                        dateMatch = dateMatch && itemDateObj <= toDateObj;
                    }
                }
                
                return searchMatch && typeMatch && severityMatch && dateMatch;
            });
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã—Ö
            document.getElementById('filtered-count').textContent = filteredData.length;
            
            renderData();
        }

        function renderData() {
            // Update map with highlighting for selected items
            map.eachLayer(l => { if (l instanceof L.Marker) map.removeLayer(l); });
            filteredData.forEach(item => {
                const id = currentMode === 'events' ? item.id : item.clusterId;
                const coords = currentMode === 'events' 
                    ? [item.latitude, item.longitude]
                    : [item.location.latitude, item.location.longitude];
                const itemType = currentMode === 'events' ? item.eventType : item.obstacleType;
                const itemSeverity = currentMode === 'events' ? item.severity : item.severity?.max;
                
                // –°–æ–∑–¥–∞–µ–º –º–∞—Ä–∫–µ—Ä —Å –∫–∞—Å—Ç–æ–º–Ω–æ–π –∏–∫–æ–Ω–∫–æ–π –µ—Å–ª–∏ —ç–ª–µ–º–µ–Ω—Ç –≤—ã–±—Ä–∞–Ω
                const isSelected = selectedIds.has(id);
                const markerOptions = isSelected ? {
                    icon: L.divIcon({
                        className: 'custom-marker-selected',
                        html: '<div style="background: #fbbf24; width: 24px; height: 24px; border-radius: 50%; border: 3px solid #fff; box-shadow: 0 0 10px rgba(251, 191, 36, 0.8);"></div>',
                        iconSize: [24, 24]
                    })
                } : {};
                
                L.marker(coords, markerOptions).addTo(map).bindPopup(`
                    <b>${itemType}</b><br>
                    –°–µ—Ä—å–µ–∑–Ω–æ—Å—Ç—å: ${itemSeverity}<br>
                    –£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: ${(item.confidence * 100).toFixed(0)}%<br>
                    ${isSelected ? '<span style="color: #fbbf24; font-weight: bold;">‚úì –í—ã–±—Ä–∞–Ω–æ</span><br>' : ''}
                    <button onclick="editItem('${id}', '${currentMode}')" style="margin-top: 0.5rem; padding: 0.25rem 0.5rem; border: none; background: #3b82f6; color: white; border-radius: 0.25rem; cursor: pointer;">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                `);
            });
            
            // Update list
            const listEl = document.getElementById('data-list');
            if (filteredData.length === 0) {
                listEl.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üì≠</div><div>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div></div>';
                return;
            }
            
            listEl.innerHTML = filteredData.map(item => {
                const id = currentMode === 'events' ? item.id : item.clusterId;
                const itemType = currentMode === 'events' ? item.eventType : item.obstacleType;
                const itemSeverity = currentMode === 'events' ? item.severity : item.severity?.max || 5;
                const timestamp = currentMode === 'events' ? item.timestamp : item.lastReported;
                const isChecked = selectedIds.has(id);  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤—ã–±—Ä–∞–Ω –ª–∏ —ç–ª–µ–º–µ–Ω—Ç
                const typeLabels = {
                    'pothole': 'üï≥Ô∏è –Ø–º–∞',
                    'bump': '„Ä∞Ô∏è –ù–µ—Ä–æ–≤–Ω–æ—Å—Ç—å',
                    'speed_bump': 'üöß –õ–µ–∂–∞—á–∏–π',
                    'vibration': '„Ä∞Ô∏è„Ä∞Ô∏è –í–∏–±—Ä–∞—Ü–∏—è',
                    'braking': 'üöó –¢–æ—Ä–º–æ–∂–µ–Ω–∏–µ'
                };
                
                return `
                    <div class="data-item" style="${isChecked ? 'border-color: #fbbf24; background: rgba(251, 191, 36, 0.1);' : ''}">
                        <div class="item-header">
                            <div>
                                <input type="checkbox" class="checkbox" value="${id}" ${isChecked ? 'checked' : ''} onchange="toggleSelect(this)">
                                <span class="item-type">${typeLabels[itemType] || itemType}</span>
                                <span class="severity-badge severity-${itemSeverity}">S${itemSeverity}</span>
                            </div>
                        </div>
                        <div class="item-details">
                            –£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: ${(item.confidence * 100).toFixed(0)}%<br>
                            ${currentMode === 'events' ? `–°–∫–æ—Ä–æ—Å—Ç—å: ${((item.speed || 0) * 3.6).toFixed(1)} –∫–º/—á<br>` : `–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–π: ${item.reportCount} (–æ—Ç —Ä–∞–∑–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤)<br>`}
                            –í—Ä–µ–º—è: ${new Date(timestamp).toLocaleString('ru-RU', {day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit'})}
                        </div>
                        <div class="item-actions">
                            <button class="icon-btn edit" onclick="editItem('${id}', '${currentMode}')">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                            <button class="icon-btn delete" onclick="deleteItem('${id}', '${currentMode}')">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
                            <button class="icon-btn" onclick="zoomToItem('${id}')">üìç –ù–∞ –∫–∞—Ä—Ç–µ</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function zoomToItem(id) {
            const item = currentMode === 'events' 
                ? allEvents.find(e => e.id === id)
                : allClusters.find(c => c.clusterId === id);
            if (item) {
                const coords = currentMode === 'events'
                    ? [item.latitude, item.longitude]
                    : [item.location.latitude, item.location.longitude];
                map.setView(coords, 16);
            }
        }
        
        function updateMapHighlights() {
            // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –∫–∞—Ä—Ç—É –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–¥—Å–≤–µ—Ç–∫–∏
            renderData();
        }

        function toggleSelect(cb) {
            if (cb.checked) selectedIds.add(cb.value);
            else selectedIds.delete(cb.value);
            document.getElementById('bulk-actions').classList.toggle('active', selectedIds.size > 0);
            document.getElementById('selected-count').textContent = selectedIds.size;
            updateMapHighlights(); // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É –Ω–∞ –∫–∞—Ä—Ç–µ
        }
        
        function selectAllFiltered(checked) {
            // –í—ã–±–∏—Ä–∞–µ–º/—Å–Ω–∏–º–∞–µ–º –≤—ã–±–æ—Ä —Å–æ –≤—Å–µ—Ö –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
            selectedIds.clear();
            if (checked) {
                filteredData.forEach(item => {
                    const id = currentMode === 'events' ? item.id : item.clusterId;
                    selectedIds.add(id);
                });
            }
            // –û–±–Ω–æ–≤–ª—è–µ–º —á–µ–∫–±–æ–∫—Å—ã –≤ —Å–ø–∏—Å–∫–µ
            document.querySelectorAll('.data-item .checkbox').forEach(cb => {
                cb.checked = checked;
            });
            document.getElementById('bulk-actions').classList.toggle('active', selectedIds.size > 0);
            document.getElementById('selected-count').textContent = selectedIds.size;
            updateMapHighlights(); // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É –Ω–∞ –∫–∞—Ä—Ç–µ
        }

        function editItem(id, type) {
            const item = type === 'events' ? allEvents.find(e => e.id === id) : allClusters.find(c => c.clusterId === id);
            if (!item) return;
            document.getElementById('modal-title').textContent = type === 'events' ? '–ü—Ä–æ—Å–º–æ—Ç—Ä/–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è' : '–ü—Ä–æ—Å–º–æ—Ç—Ä/–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–ª–∞—Å—Ç–µ—Ä–∞';
            
            // –°–æ–∑–¥–∞–µ–º –ø–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∞—Ç—Ä–∏–±—É—Ç–æ–≤
            const allAttributesHtml = `
                <div style="background: #0f172a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; max-height: 400px; overflow-y: auto;">
                    <h3 style="color: #60a5fa; margin-bottom: 0.5rem;">–í—Å–µ –∞—Ç—Ä–∏–±—É—Ç—ã:</h3>
                    <pre style="color: #cbd5e1; font-size: 0.875rem; white-space: pre-wrap; word-break: break-all;">${JSON.stringify(item, null, 2)}</pre>
                </div>
            `;
            
            document.getElementById('edit-form').innerHTML = type === 'events' ? `
                ${allAttributesHtml}
                <div class="form-group"><label>–¢–∏–ø</label><select id="edit-type">
                    <option value="pothole" ${item.eventType === 'pothole' ? 'selected' : ''}>–Ø–º–∞</option>
                    <option value="bump" ${item.eventType === 'bump' ? 'selected' : ''}>–ù–µ—Ä–æ–≤–Ω–æ—Å—Ç—å</option>
                    <option value="speed_bump" ${item.eventType === 'speed_bump' ? 'selected' : ''}>–õ–µ–∂–∞—á–∏–π –ø–æ–ª–∏—Ü–µ–π—Å–∫–∏–π</option>
                    <option value="vibration" ${item.eventType === 'vibration' ? 'selected' : ''}>–í–∏–±—Ä–∞—Ü–∏—è</option>
                    <option value="braking" ${item.eventType === 'braking' ? 'selected' : ''}>–¢–æ—Ä–º–æ–∂–µ–Ω–∏–µ</option>
                </select></div>
                <div class="form-group"><label>–°–µ—Ä—å–µ–∑–Ω–æ—Å—Ç—å (1-5)</label><input type="number" id="edit-severity" min="1" max="5" value="${item.severity}"></div>
                <div class="form-group"><label>–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å (0-1)</label><input type="number" id="edit-confidence" step="0.01" min="0" max="1" value="${item.confidence}"></div>
                <div class="form-group"><label>–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã</label><input type="text" readonly value="lat: ${item.latitude?.toFixed(6)}, lon: ${item.longitude?.toFixed(6)}" style="background: #1e293b;"></div>
                <div class="form-group"><label>–°–∫–æ—Ä–æ—Å—Ç—å</label><input type="text" readonly value="${((item.speed || 0) * 3.6).toFixed(1)} –∫–º/—á" style="background: #1e293b;"></div>
                <div class="form-group"><label>Magnitude –∞–∫—Å–µ–ª–µ—Ä–æ–º–µ—Ç—Ä–∞</label><input type="text" readonly value="${item.accelerometer_magnitude?.toFixed(3)} –º/—Å¬≤" style="background: #1e293b;"></div>
                <div class="form-group"><label>–ú–µ—Ç–æ–¥ –¥–µ—Ç–µ–∫—Ü–∏–∏</label><input type="text" readonly value="${item.detection_method || 'N/A'}" style="background: #1e293b;"></div>
                <div class="form-group"><label>–ó–∞–º–µ—Ç–∫–∏</label><textarea id="edit-notes">${item.notes || item.note || ''}</textarea></div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
                    <button type="button" class="btn btn-primary" onclick="saveEdit('${id}', 'events')">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
                </div>
            ` : `
                ${allAttributesHtml}
                <div class="form-group"><label>–¢–∏–ø</label><select id="edit-type">
                    <option value="pothole" ${item.obstacleType === 'pothole' ? 'selected' : ''}>–Ø–º–∞</option>
                    <option value="bump" ${item.obstacleType === 'bump' ? 'selected' : ''}>–ù–µ—Ä–æ–≤–Ω–æ—Å—Ç—å</option>
                    <option value="speed_bump" ${item.obstacleType === 'speed_bump' ? 'selected' : ''}>–õ–µ–∂–∞—á–∏–π –ø–æ–ª–∏—Ü–µ–π—Å–∫–∏–π</option>
                    <option value="vibration" ${item.obstacleType === 'vibration' ? 'selected' : ''}>–í–∏–±—Ä–∞—Ü–∏—è</option>
                    <option value="braking" ${item.obstacleType === 'braking' ? 'selected' : ''}>–¢–æ—Ä–º–æ–∂–µ–Ω–∏–µ</option>
                </select></div>
                <div class="form-group"><label>–ú–∞–∫—Å. —Å–µ—Ä—å–µ–∑–Ω–æ—Å—Ç—å (1-5)</label><input type="number" id="edit-severity-max" min="1" max="5" value="${item.severity?.max || 5}"></div>
                <div class="form-group"><label>–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å (0-1)</label><input type="number" id="edit-confidence" step="0.01" min="0" max="1" value="${item.confidence}"></div>
                <div class="form-group"><label>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–π (reportCount)</label><input type="text" readonly value="${item.reportCount} –æ—Ç ${item.devices?.length || 0} —É—Å—Ç—Ä–æ–π—Å—Ç–≤" style="background: #1e293b;"></div>
                <div class="form-group"><label>–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã</label><input type="text" readonly value="lat: ${item.location?.latitude?.toFixed(6)}, lon: ${item.location?.longitude?.toFixed(6)}" style="background: #1e293b;"></div>
                <div class="form-group"><label>–°—Ä–µ–¥–Ω—è—è —Å–∫–æ—Ä–æ—Å—Ç—å</label><input type="text" readonly value="${((item.roadInfo?.avgSpeed || 0) * 3.6).toFixed(1)} –∫–º/—á" style="background: #1e293b;"></div>
                <div class="form-group"><label>–†–∞–¥–∏—É—Å –∫–ª–∞—Å—Ç–µ—Ä–∞</label><input type="text" readonly value="${item.location?.radius || 8} –º–µ—Ç—Ä–æ–≤" style="background: #1e293b;"></div>
                <div class="form-group"><label>–°—Ç–∞—Ç—É—Å</label><select id="edit-status">
                    <option value="active" ${item.status === 'active' ? 'selected' : ''}>–ê–∫—Ç–∏–≤–Ω—ã–π</option>
                    <option value="expired" ${item.status === 'expired' ? 'selected' : ''}>–ò—Å—Ç—ë–∫—à–∏–π</option>
                    <option value="fixed" ${item.status === 'fixed' ? 'selected' : ''}>–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ</option>
                </select></div>
                <div class="form-group"><label>–ó–∞–º–µ—Ç–∫–∏</label><textarea id="edit-notes">${item.notes || ''}</textarea></div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
                    <button type="button" class="btn btn-primary" onclick="saveEdit('${id}', 'clusters')">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
                </div>
            `;
            document.getElementById('edit-modal').classList.add('active');
        }

        async function saveEdit(id, type) {
            try {
                const body = type === 'events' ? {
                    eventType: document.getElementById('edit-type').value,
                    severity: parseInt(document.getElementById('edit-severity').value),
                    confidence: parseFloat(document.getElementById('edit-confidence').value),
                    notes: document.getElementById('edit-notes').value
                } : {
                    obstacleType: document.getElementById('edit-type').value,
                    severity_max: parseInt(document.getElementById('edit-severity-max').value),
                    confidence: parseFloat(document.getElementById('edit-confidence').value),
                    status: document.getElementById('edit-status').value,
                    notes: document.getElementById('edit-notes').value
                };
                const res = await fetch(`/api/admin/editor/${type}/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                if (res.ok) {
                    showAlert('success', '‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
                    closeModal();
                    loadData();
                } else {
                    const error = await res.json();
                    showAlert('error', '–û—à–∏–±–∫–∞: ' + error.detail);
                }
            } catch (error) {
                showAlert('error', '–û—à–∏–±–∫–∞: ' + error.message);
            }
        }

        async function deleteItem(id, type) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —ç–ª–µ–º–µ–Ω—Ç?')) return;
            try {
                const res = await fetch(`/api/admin/editor/${type}/${id}`, { method: 'DELETE' });
                if (res.ok) {
                    showAlert('success', '‚úÖ –£–¥–∞–ª–µ–Ω–æ');
                    loadData();
                } else {
                    showAlert('error', '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
                }
            } catch (error) {
                showAlert('error', '–û—à–∏–±–∫–∞: ' + error.message);
            }
        }

        async function bulkDelete() {
            if (!confirm(`–£–¥–∞–ª–∏—Ç—å ${selectedIds.size} —ç–ª–µ–º–µ–Ω—Ç–æ–≤?`)) return;
            try {
                const res = await fetch(`/api/admin/editor/${currentMode}/bulk-delete`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ids: Array.from(selectedIds) })
                });
                if (res.ok) {
                    showAlert('success', '‚úÖ –£–¥–∞–ª–µ–Ω–æ ' + selectedIds.size);
                    selectedIds.clear();
                    loadData();
                } else {
                    showAlert('error', '–û—à–∏–±–∫–∞ –º–∞—Å—Å–æ–≤–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è');
                }
            } catch (error) {
                showAlert('error', '–û—à–∏–±–∫–∞: ' + error.message);
            }
        }

        function closeModal() {
            document.getElementById('edit-modal').classList.remove('active');
        }

        function showHelp() {
            document.getElementById('help-modal').classList.add('active');
        }

        function closeHelpModal() {
            document.getElementById('help-modal').classList.remove('active');
        }

        function showAlert(type, message) {
            const container = document.getElementById('alerts-container');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            container.appendChild(alert);
            setTimeout(() => alert.remove(), 3000);
        }
    </script>
</body>
</html>